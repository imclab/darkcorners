function Cache(){this.models={},this.geometries={},this.materials={};var e=this,t=new THREE.JSONLoader;this.loadModel=function(n,r){var i=this.models[n];i?i instanceof Array?i.push(r):r(i):(this.models[n]=[r],t.load(n,function(t){var r=e.models[n];for(var i=0;i<r.length;++i)r[i](t);e.models[n]=t}))},this.getGeometry=function(e,t){var n=this.geometries[e];return n?n:(this.geometries[e]=n=t(),n)},this.getMaterial=function(e){var t=this.materials[e];return t?t:(this.materials[e]=t=createMaterial(e),t)}}function LightManager(e){e=e||{},this.maxLights=e.maxLights||4,this.maxShadows=e.maxShadows||2,this.lights=[],this.shadows=[],this.addLight=function(e){this.lights.push(e)},this.addShadow=function(e){this.shadows.push(e)};var t=0,n=new THREE.Vector2,r=new THREE.Vector2;this.update=function(e){function i(t,i){return n.set(t.x-e.position.x,t.z-e.position.z).normalize(),r.set(i.x-e.position.x,i.z-e.position.z).normalize(),Math.acos(n.dot(r))}function s(e,t){var n=t.x-e.x,r=t.z-e.z;return n*n+r*r}function o(t,n){return s(t.position,e.position)-s(n.position,e.position)}if(++t<=20)return;t=0;var u,a=0;this.lights.sort(o);for(u=0;u<this.lights.length;++u)a<this.maxLights&&(i(this.lights[u].position,controls.target)<Math.PI*.4||s(this.lights[u].position,e.position)<1.5*this.lights[u].distance*this.lights[u].distance)?(this.lights[u].visible=!0,++a):this.lights[u].visible=!1;this.shadows.sort(o);for(u=0;u<this.shadows.length;++u)u<this.maxShadows?this.shadows[u].castShadow=!0:this.shadows[u].castShadow=!1}}function loadTexture(e){var t=new Image;t.onload=function(){n.needsUpdate=!0},t.src=e;var n=new THREE.Texture(t,new THREE.UVMapping,THREE.RepeatWrapping,THREE.RepeatWrapping,CONFIG.linearTextureFilter?THREE.LinearFilter:THREE.NearestFilter,CONFIG.linearTextureFilter?THREE.LinearMipMapLinearFilter:THREE.NearestFilter,THREE.RGBFormat,THREE.UnsignedByteType,CONFIG.anisotropy);return _textures.push(n),n}function updateTextures(){for(var e=0;e<_textures.length;++e)_textures[e].magFilter=CONFIG.linearTextureFilter?THREE.LinearFilter:THREE.NearestFilter,_textures[e].minFilter=CONFIG.linearTextureFilter?THREE.LinearMipMapLinearFilter:THREE.NearestFilter,_textures[e].anisotropy=CONFIG.anisotropy,_textures[e].needsUpdate=!0;updateConfig()}function updateMaterials(){for(var e in cache.materials){if(!cache.materials.hasOwnProperty(e))continue;cache.materials[e].needsUpdate=!0}updateConfig()}function createMaterial(e){var t="assets/textures/",n=3355443,r=12303291,i=16777215,s=30,o=1;return new THREE.MeshPhongMaterial({ambient:n,diffuse:r,specular:i,shininess:s,perPixel:!0,map:loadTexture(t+e+".jpg"),specularMap:CONFIG.specularMapping?loadTexture(t+"specular/"+e+".jpg"):undefined,normalMap:CONFIG.normalMapping?loadTexture(t+"normal/"+e+".jpg"):undefined})}function dumpInfo(){var e=renderer.context;gl_info={Version:e.getParameter(e.VERSION),"Shading language":e.getParameter(e.SHADING_LANGUAGE_VERSION),Vendor:e.getParameter(e.VENDOR),Renderer:e.getParameter(e.RENDERER),"Max varying vectors":e.getParameter(e.MAX_VARYING_VECTORS),"Max vertex attribs":e.getParameter(e.MAX_VERTEX_ATTRIBS),"Max vertex uniform vectors":e.getParameter(e.MAX_VERTEX_UNIFORM_VECTORS),"Max fragment uniform vectors":e.getParameter(e.MAX_FRAGMENT_UNIFORM_VECTORS),"Max renderbuffer size":e.getParameter(e.MAX_RENDERBUFFER_SIZE),"Max texture size":e.getParameter(e.MAX_TEXTURE_SIZE),"Max cube map texture size":e.getParameter(e.MAX_CUBE_MAP_TEXTURE_SIZE),"Max texture image units":e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS),"Max vertex texture units":e.getParameter(e.MAX_VERTEX_TEXTURE_IMAGE_UNITS),"Max combined texture units":e.getParameter(e.MAX_COMBINED_TEXTURE_IMAGE_UNITS),"Max viewport dims":e.getParameter(e.MAX_VIEWPORT_DIMS)[0]+"x"+e.getParameter(e.MAX_VIEWPORT_DIMS)[1]},console.log("WebGL info: ",gl_info)}function particleSystemCreator(e,t){var n,r=new THREE.Geometry;for(n=0;n<e.nParticles();n++)r.vertices.push(new THREE.Vector3);r.colors=new Array(e.nParticles());for(n=0;n<e.nParticles();n++)r.colors[n]=new THREE.Color;var i=Fireworks.ProceduralTextures.buildTexture(),s=new THREE.ParticleBasicMaterial({color:(new THREE.Color(15632384)).getHex(),size:.3,sizeAttenuation:!0,vertexColors:!0,map:i,blending:THREE.AdditiveBlending,depthWrite:!1,transparent:!0}),o=new THREE.ParticleSystem(r,s);return o.dynamic=!0,o.sortParticles=!0,o.position=t,scene.add(o),o}function createSimpleFire(e){var t=Fireworks.createEmitter({nParticles:30});return t.effectsStackBuilder().spawnerSteadyRate(20).position(Fireworks.createShapeSphere(0,0,0,.1)).velocity(Fireworks.createShapePoint(0,1,0)).lifeTime(.3,.6).renderToThreejsParticleSystem({particleSystem:particleSystemCreator(t,e)}).back().start(),t}function Dungeon(e,t){function f(e,t,n){if(!t.length)return!1;n=n?n*n:1e-6;for(var r=0;r<t.length;++r){var i=t[r].position.x-e.x,s=t[r].position.z-e.z;if(i*i+s*s<=n)return!0}return!1}function l(e,t){var n=0;return n+=t.get(e.x-1,e.z)==u?1:0,n+=t.get(e.x+1,e.z)==u?1:0,n+=t.get(e.x,e.z-1)==u?1:0,n+=t.get(e.x,e.z+1)==u?1:0,n==2}var n=this;this.objects=[];var r=new THREE.MeshBasicMaterial({color:0}),i=new THREE.MeshBasicMaterial({color:16711935}),s=2,o=3,u="#",a=".";this.levels=[],this.generate=function(){var e=1;for(var t=0;t<e;++t)this.levels.push(this.generateLevel(new THREE.Vector3))},this.generateLevel=function(e){var n=rand(25,35),r=rand(25,35),i={map:new Array(n*r)};i.width=n,i.depth=r;var o,f;i.get=function(e,t){return e<0||e>=n?u:t<0||t>=r?u:i.map[t*n+e]},i.set=function(e,t,s){if(e<0||e>=n)return;if(t<0||t>=r)return;i.map[t*n+e]=s},i.env=randProp(assets.environments);for(f=0;f<r;++f)for(o=0;o<n;++o)i.set(o,f,u);var l=rand(3,4),c=Math.floor(n*r/(l*l*4)),h=rand(l+1,n-l-1),p=rand(l+1,r-l-1),d,v,m,g;for(var y=0;y<c;++y){var b=rand(2,l),w=rand(2,l),E=h-rand(0,b-1),S=p-rand(0,w-1);for(f=S;f<S+w;++f)for(o=E;o<E+b;++o)i.set(o,f,a);d=h,v=p;if(y==c-1)break;do h=rand(l+1,n-l-1),p=rand(l+1,r-l-1);while(i.get(h,p)==u&&Math.abs(d-h)+Math.abs(v-p)>=30);m=h<d;for(o=m?h:d;o<(m?d:h);++o)i.set(o,v,a);g=p<v;for(f=g?p:v;f<(g?v:p);++f)i.set(h,f,a)}i.floorCount=0;for(p=0;p<r;++p)for(h=0;h<n;++h)i.get(h,p)==a&&i.floorCount++;do h=rand(l+1,n-l-1),p=rand(l+1,r-l-1);while(i.get(h,p)==u);return t.geometry.computeBoundingBox(),t.position.x=h*s,t.position.y=.5*(t.geometry.boundingBox.max.y-t.geometry.boundingBox.min.y)+.001,t.position.z=p*s,i},this.generateMesh=function(t){function h(e){return function(){var t=c.roughness?10:0;return new BlockGeometry(s,o,s,t,t,t,l,e,s/2,o/2,c.roughness)}}function N(t,n,r,i){var u=new Physijs.PlaneMesh(new PlaneGeometry(s*t,o,1,1,n,t,o/2),cache.getMaterial(f),0);u.position.set(r,o/2,i),e.add(u)}var n=randElem(t.env.floor),i=randElem(t.env.ceiling),f=randElem(t.env.wall),l=[cache.getMaterial(f),cache.getMaterial(f),r,r,cache.getMaterial(f),cache.getMaterial(f)],c={};assets.materials[f]&&assets.materials[f].roughness&&(c.roughness=assets.materials[f].roughness);var p=new THREE.Geometry,d,v,m,g,y,b,w;for(var E=0;E<t.depth;++E)for(var S=0;S<t.width;++S){m=g=y=b=py=ny=0,v=t.get(S,E);if(v===a)continue;if(v===u){m=t.get(S+1,E)==u?0:1,g=t.get(S-1,E)==u?0:2,y=t.get(S,E+1)==u?0:4,b=t.get(S,E-1)==u?0:8,w=m+g+y+b;if(w===0)continue;var x=cache.getGeometry(w,h({px:m,nx:g,py:0,ny:0,pz:y,nz:b}));d=new THREE.Mesh(x),d.position.x=(S+.5)*s,d.position.y=.5*o,d.position.z=(E+.5)*s,THREE.GeometryUtils.merge(p,d),x.computeBoundingBox(),Math.abs(x.boundingBox.max.x-x.boundingBox.min.x)<=.5&&(x.boundingBox.min.x=-0.5*s,x.boundingBox.max.x=.5*s),Math.abs(x.boundingBox.max.z-x.boundingBox.min.z)<=.5&&(x.boundingBox.min.z=-0.5*s,x.boundingBox.max.z=.5*s);var T=new Physijs.BoxMesh(x,r,0);T.position.copy(d.position),T.visible=!1,e.add(T)}}N(t.depth,"px",0,s*t.depth/2),N(t.depth,"nx",s*t.width,s*t.depth/2),N(t.width,"pz",s*t.width/2,0),N(t.width,"nz",s*t.width/2,s*t.depth);var C=new THREE.Mesh(new PlaneGeometry(s*t.width,s*t.depth,1,1,"ny",t.width,t.depth),cache.getMaterial(i));C.position.set(s*t.width*.5,o,s*t.depth*.5),e.add(C);var k=new Physijs.PlaneMesh(new PlaneGeometry(s*t.width,s*t.depth,1,1,"py",t.width,t.depth),Physijs.createMaterial(cache.getMaterial(n),.9,0),0);k.position.set(s*t.width*.5,0,s*t.depth*.5),k.receiveShadow=!0,e.add(k),p.computeTangents(),d=new THREE.Mesh(p,new THREE.MeshFaceMaterial),d.receiveShadow=!0,e.add(d)},this.generateLights=function(n){e.add(new THREE.AmbientLight(11184810));var r=Math.floor(n.floorCount/20),i=new THREE.Vector3,a=0;while(a<r){i.x=rand(0,n.width),i.z=rand(0,n.depth);if(n.get(i.x,i.z)===u)continue;var l=rand(0,3)*Math.PI*.5,c=Math.round(Math.cos(l)),h=-Math.round(Math.sin(l));while(n.get(i.x,i.z)!==u)i.x+=c,i.z+=h;i.x=(i.x-.6*c+.5)*s,i.z=(i.z-.6*h+.5)*s,i.y=o*.7;if(f(i,lightManager.lights,4.1*s))continue;++a;var p=new THREE.PointLight(16777130,1,2*s);p.position.copy(i),e.add(p),lightManager.addLight(p);var d=new THREE.SpotLight(16777130,p.intensity,p.distance);d.position=p.position,d.target.position.copy(d.position),d.target.position.x-=c*1.1,d.target.position.y-=1,d.target.position.z-=h*1.1,d.angle=Math.PI/2,d.castShadow=!0,d.onlyShadow=!0,d.shadowCameraNear=.1*UNIT,d.shadowCameraFar=p.distance*1.5*UNIT,d.shadowCameraFov=100,d.shadowBias=-0.0002,d.shadowDarkness=.3,d.shadowMapWidth=256,d.shadowMapHeight=256,d.shadowCameraVisible=!1,e.add(d),lightManager.addShadow(d),CONFIG.particles&&(p.emitter=createSimpleFire(p.position))}t.light=new THREE.PointLight(8961023,1,s*3),e.add(t.light),t.shadow=new THREE.SpotLight(t.light.color,t.light.intensity,t.light.distance),t.shadow.angle=Math.PI/4,t.shadow.onlyShadow=!0,t.shadow.castShadow=!0,t.shadow.shadowCameraNear=.1*UNIT,t.shadow.shadowCameraFar=10*UNIT,t.shadow.shadowCameraFov=90,t.shadow.shadowBias=-0.0002,t.shadow.shadowDarkness=.3,t.shadow.shadowMapWidth=1024,t.shadow.shadowMapHeight=1024,t.shadow.shadowCameraVisible=!1,e.add(t.shadow)},this.generateObjects=function(t){function r(t,r){function i(e){if(!e)return;e.anisotropy=CONFIG.anisotropy,e.needsUpdate=!0}return function(o){r||(r={});var u,a=r.mass||0,f=1;r.randScale&&(f+=randf(-r.randScale,r.randScale),a*=f);var l=o.materials.length>1?new THREE.MeshFaceMaterial:o.materials[0];if(r.collision){var c=Physijs.createMaterial(l,.7,.2);if(r.collision=="plane")u=new Physijs.PlaneMesh(o,c,a);else if(r.collision=="box")u=new Physijs.BoxMesh(o,c,a);else if(r.collision=="sphere")u=new Physijs.SphereMesh(o,c,a);else if(r.collision=="cylinder")u=new Physijs.CylinderMesh(o,c,a);else if(r.collision=="cone")u=new Physijs.ConeMesh(o,c,a);else{if(r.collision!="convex")throw"Unsupported collision mesh type "+r.collision;u=new Physijs.ConvexMesh(o,c,a)}n.objects.push(u)}else u=new THREE.Mesh(o,l);t.y===null&&(o.boundingBox||o.computeBoundingBox(),t.y=.5*(o.boundingBox.max.y-o.boundingBox.min.y)+.001),u.position.copy(t),u.scale.set(f,f,f),r.noShadows||(u.castShadow=!0,u.receiveShadow=!0),i(u.material.map),i(u.material.normalMap),i(u.material.specularMap),e.add(u)}}var i=Math.floor(t.floorCount/8),o=new THREE.Vector3,a=0;while(a<i){o.x=rand(0,t.width),o.z=rand(0,t.depth);if(t.get(o.x,o.z)===u)continue;if(l(o,t))continue;o.x=(o.x+.5)*s,o.z=(o.z+.5)*s,o.y=null;if(f(o,this.objects,1.4*s))continue;++a;var c=randElem(t.env.objects),h=cache.loadModel("assets/models/"+c+"/"+c+".js",r((new THREE.Vector3).copy(o),assets.objects[c]))}},this.generate(),this.generateMesh(this.levels[0]),this.generateLights(this.levels[0]),this.generateObjects(this.levels[0])}function randProp(e){var t,n=0;for(var r in e)Math.random()<1/++n&&(t=r);return e[t]}function randElem(e){return e[Math.random()*e.length|0]}function rand(e,t){return e+Math.floor(Math.random()*(t-e+1))}function randf(e,t){return e+Math.random()*(t-e)}function initUI(){container=document.getElementById("container"),container.innerHTML="",container.appendChild(renderer.domElement),renderStats=new Stats,renderStats.domElement.style.position="absolute",renderStats.domElement.style.bottom="0px",container.appendChild(renderStats.domElement),physicsStats=new Stats,physicsStats.domElement.style.position="absolute",physicsStats.domElement.style.bottom="0px",physicsStats.domElement.style.left="85px",container.appendChild(physicsStats.domElement),container.requestPointerLock=container.requestPointerLock||container.mozRequestPointerLock||container.webkitRequestPointerLock,container.requestFullscreen=container.requestFullscreen||container.mozRequestFullscreen||container.mozRequestFullScreen||container.webkitRequestFullscreen,$(window).resize(onWindowResize),$(window).blur(pause),$(window).focus(resume),$("#instructions").click(function(){if(/Firefox/i.test(navigator.userAgent)){var e=function(t){if(document.fullscreenElement||document.mozFullscreenElement||document.mozFullScreenElement)document.removeEventListener("fullscreenchange",e),document.removeEventListener("mozfullscreenchange",e),container.requestPointerLock()};document.addEventListener("fullscreenchange",e,!1),document.addEventListener("mozfullscreenchange",e,!1),container.requestFullscreen()}else container.requestPointerLock()}),document.addEventListener("pointerlockchange",onPointerLockChange,!1),document.addEventListener("webkitpointerlockchange",onPointerLockChange,!1),document.addEventListener("mozpointerlockchange",onPointerLockChange,!1),$("#instructions").show();var e=new dat.GUI;e.add(controls,"mouseFallback");var t=e.addFolder("Renderer options (reload required)");t.add(CONFIG,"antialias").onChange(updateConfig),t.add(CONFIG,"physicalShading").onChange(updateConfig),t.add(CONFIG,"normalMapping").onChange(updateConfig),t.add(CONFIG,"specularMapping").onChange(updateConfig),t.add(CONFIG,"particles").onChange(updateConfig),t.add(window,"reload");var n=e.addFolder("Light and shadow");n.add(CONFIG,"maxLights",0,6).step(1).onChange(updateConfig),n.add(CONFIG,"maxShadows",0,6).step(1).onChange(updateConfig),n.add(CONFIG,"shadows").onChange(updateMaterials),n.add(CONFIG,"softShadows").onChange(updateMaterials);var r=e.addFolder("Texture options");r.add(CONFIG,"anisotropy",1,renderer.getMaxAnisotropy()).step(1).onChange(updateTextures),r.add(CONFIG,"linearTextureFilter").onChange(updateTextures);var i=e.addFolder("Post-processing");i.add(CONFIG,"postprocessing").onChange(updateConfig),i.add(CONFIG,"SSAO").onChange(updateConfig),i.add(CONFIG,"FXAA").onChange(updateConfig),i.add(CONFIG,"bloom").onChange(updateConfig)}function onWindowResize(){pl.camera.aspect=window.innerWidth/window.innerHeight,pl.camera.updateProjectionMatrix(),renderer.setSize(window.innerWidth,window.innerHeight),composer.reset(),passes.ssao.uniforms.size.value.set(window.innerWidth,window.innerHeight),passes.fxaa.uniforms.resolution.value.set(1/window.innerWidth,1/window.innerHeight),controls.handleResize()}function onPointerLockChange(){document.pointerLockElement||document.mozPointerLockElement||document.webkitPointerLockElement?(controls.pointerLockEnabled=!0,$("#instructions").hide()):(controls.pointerLockEnabled=!1,$("#instructions").show())}function pause(){controls.active=!1}function resume(){controls.active=!0}function reload(){updateConfig(),window.location.reload()}function init(){scene=new Physijs.Scene,scene.setGravity(new THREE.Vector3(0,-10*UNIT,0)),scene.fog=new THREE.FogExp2(0,.05),scene.addEventListener("update",function(){physicsStats.update()}),pl=new Physijs.CylinderMesh(new THREE.CylinderGeometry(.8*UNIT,.8*UNIT,2*UNIT),new THREE.MeshBasicMaterial({color:16711935}),100),pl.visible=!1,pl.camera=new THREE.PerspectiveCamera(60,window.innerWidth/window.innerHeight,.1*UNIT,30*UNIT),controls=new Controls(pl.camera,{mouse:mouseHandler}),controls.movementSpeed=10*UNIT,controls.lookSpeed=.5,controls.lookVertical=!0,controls.constrainVerticalLook=!0,controls.verticalMin=1.1,controls.verticalMax=2.2,renderer=new THREE.WebGLRenderer({clearColor:0,maxLights:CONFIG.maxLights+2,antialias:CONFIG.antialias}),renderer.setSize(window.innerWidth,window.innerHeight),renderer.shadowMapEnabled=CONFIG.shadows,renderer.shadowMapSoft=CONFIG.softShadows,renderer.shadowMapDebug=!1,renderer.gammaInput=!0,renderer.gammaOutput=!0,renderer.physicallyBasedShading=CONFIG.physicalShading,renderer.autoClear=!1,CONFIG.anisotropy||(CONFIG.anisotropy=renderer.getMaxAnisotropy()),renderTargetParametersRGB={minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBFormat},renderTargetParametersRGBA={minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBAFormat},depthTarget=new THREE.WebGLRenderTarget(window.innerWidth,window.innerHeight,renderTargetParametersRGBA),colorTarget=new THREE.WebGLRenderTarget(window.innerWidth,window.innerHeight,renderTargetParametersRGB),passes.scene=new THREE.RenderPass(scene,pl.camera),passes.ssao=new THREE.ShaderPass(THREE.ShaderExtras.ssao),passes.ssao.uniforms.tDepth.value=depthTarget,passes.ssao.uniforms.size.value.set(window.innerWidth,window.innerHeight),passes.ssao.uniforms.cameraNear.value=pl.camera.near,passes.ssao.uniforms.cameraFar.value=pl.camera.far,passes.ssao.uniforms.fogNear.value=scene.fog.near,passes.ssao.uniforms.fogFar.value=scene.fog.far,passes.ssao.uniforms.fogEnabled.value=0,passes.ssao.uniforms.aoClamp.value=.4,passes.ssao.uniforms.onlyAO.value=0,passes.fxaa=new THREE.ShaderPass(THREE.ShaderExtras.fxaa),passes.fxaa.uniforms.resolution.value.set(1/window.innerWidth,1/window.innerHeight),passes.bloom=new THREE.BloomPass(.5),passes.adjust=new THREE.ShaderPass(THREE.ShaderExtras.hueSaturation),passes.adjust.uniforms.saturation.value=.2,composer=new THREE.EffectComposer(renderer,colorTarget),composer.addPass(passes.ssao),composer.addPass(passes.fxaa),composer.addPass(passes.bloom),composer.addPass(passes.adjust),composer.passes[composer.passes.length-1].renderToScreen=!0,depthPassPlugin=new THREE.DepthPassPlugin,depthPassPlugin.renderTarget=depthTarget,renderer.addPrePlugin(depthPassPlugin),lightManager=new LightManager({maxLights:CONFIG.maxLights,maxShadows:CONFIG.maxShadows}),dungeon=new Dungeon(scene,pl),scene.add(pl),pl.setAngularFactor({x:0,y:0,z:0}),lightManager.update(pl),updateConfig(),dumpInfo(),initUI();var e=(new Date).getTime();window.performance&&console.log("Initialization took "+(e-window.performance.timing.navigationStart)+"ms")}function mouseHandler(e){var t=new THREE.Vector3(0,0,1),n=new THREE.Projector;n.unprojectVector(t,pl.camera);var r=new THREE.Ray(pl.camera.position,t.subSelf(pl.camera.position).normalize()),i=r.intersectObjects(dungeon.objects);if(i.length>0){var s=i[0].object;s.position.distanceToSquared(pl.position)<9&&s.applyCentralImpulse(t.multiplyScalar(1e3))}}function animate(e){function t(e){return Math.abs(e-(e|0)-.5)*2}function n(e){return e-(e|0)}var r,i=new THREE.Vector3,s=(new Date).getTime();for(r=0;r<lightManager.lights.length;++r){var o=lightManager.lights[r],u=s/(1e3+r);o.intensity=.5+.5*t(u),o.visible&&o.emitter&&o.emitter.update(e).render()}pl.light.intensity=.5+.5*t(s/1e3),pl.light.position.set(pl.position.x,pl.position.y+.2,pl.position.z),pl.shadow.position.copy(pl.light.position),pl.shadow.target.position.copy(controls.target),pl.rhand&&(pl.rhand.position.set(pl.position.x,pl.position.y,pl.position.z),pl.rhand.rotation.copy(pl.camera.rotation),pl.rhand.updateMatrix(),pl.rhand.rotation.y+=Math.PI/3,pl.rhand.rotation.z+=Math.PI/2,pl.rhand.translateX(.2*UNIT),pl.rhand.translateY(.2*UNIT),pl.rhand.translateZ(-0.5*UNIT))}var DEBUG=!0,UNIT=1;Detector.webgl||(Detector.addGetWebGLMessage(),document.getElementById("container").innerHTML=""),Physijs.scripts.worker="libs/physijs_worker.js",Physijs.scripts.ammo="../libs/ammo.js";var CONFIG={postprocessing:!0,particles:!0,maxLights:4,maxShadows:2,antialias:!0,anisotropy:0,shadows:!0,softShadows:!0,physicalShading:!0,normalMapping:!0,specularMapping:!0,linearTextureFilter:!0,bloom:!0,SSAO:!0,FXAA:!1},updateConfig=function(){lightManager.maxLights=CONFIG.maxLights,lightManager.maxShadows=CONFIG.maxShadows,renderer.shadowMapEnabled=CONFIG.shadows,renderer.shadowMapSoft=CONFIG.softShadows,renderer.physicallyBasedShading=CONFIG.physicalShading,passes.bloom.enabled=CONFIG.bloom,passes.ssao.enabled=CONFIG.SSAO,passes.fxaa.enabled=CONFIG.FXAA,localStorage.setItem("CONFIG",JSON.stringify(CONFIG))};(function(){var e=localStorage.getItem("CONFIG");if(e){e=JSON.parse(e);for(var t in e)e.hasOwnProperty(t)&&typeof e[t]!="function"&&(CONFIG[t]=e[t])}})(),PlaneGeometry=function(e,t,n,r,i,s,o){THREE.Geometry.call(this);var u,a,f=e/2,l=t/2,c=n||1,h=r||1,p=c+1,d=h+1,v=e/c,m=t/h,g=new THREE.Vector3,y=new THREE.Vector3,b=new THREE.Vector3;s=s||1,o=o||1,i=i||"pz";switch(i){case"nx":g.x=-1,y.z=-1,b.y=1;break;case"px":g.x=1,y.z=-1,b.y=-1;break;case"ny":g.y=-1,y.x=-1,b.z=1;break;case"py":g.y=1,y.x=-1,b.z=-1;break;case"nz":g.z=-1,y.x=1,b.y=1;break;case"pz":g.z=1,y.x=1,b.y=-1;break;default:console.error("Unknown plane direction "+i)}for(a=0;a<d;a++)for(u=0;u<p;u++){var w=u*v-f,E=a*m-l,S=new THREE.Vector3(w*y.x,w*y.y,w*y.z);S.set(S.x+E*b.x,S.y+E*b.y,S.z+E*b.z),this.vertices.push(S)}for(a=0;a<h;a++)for(u=0;u<c;u++){var x=u+p*a,T=u+p*(a+1),N=u+1+p*(a+1),C=u+1+p*a,k=new THREE.Face4(x,T,N,C);k.normal.copy(g),k.vertexNormals.push(g.clone(),g.clone(),g.clone(),g.clone()),this.faces.push(k),this.faceVertexUvs[0].push([new THREE.UV(u/c*s,(1-a/h)*o),new THREE.UV(u/c*s,(1-(a+1)/h)*o),new THREE.UV((u+1)/c*s,(1-(a+1)/h)*o),new THREE.UV((u+1)/c*s,(1-a/h)*o)])}this.computeCentroids()},PlaneGeometry.prototype=Object.create(THREE.Geometry.prototype),BlockGeometry=function(e,t,n,r,i,s,o,u,a,f,l){function x(e,t,n,o,u,h,p,d,v){var m,g,y,b=r||1,w=i||1,E=u/2,S=h/2,x=c.vertices.length;if(e==="x"&&t==="y"||e==="y"&&t==="x")m="z";else if(e==="x"&&t==="z"||e==="z"&&t==="x")m="y",w=s||1;else if(e==="z"&&t==="y"||e==="y"&&t==="z")m="x",b=s||1;var T=b+1,N=w+1,C=u/b,k=h/w,L=new THREE.Vector3;L[m]=p>0?1:-1,v&&(L[m]*=-1);for(y=0;y<N;y++)for(g=0;g<T;g++){var A=new THREE.Vector3;A[e]=(g*C-E)*n,A[t]=(y*k-S)*o,A[m]=p,l&&g>0&&g<T-1&&(A[m]+=-l+Math.random()*l*2),c.vertices.push(A)}for(y=0;y<w;y++)for(g=0;g<b;g++){var O=g+T*y,M=g+T*(y+1),_=g+1+T*(y+1),D=g+1+T*y,P=new THREE.Face4(O+x,M+x,_+x,D+x);P.normal.copy(L),P.vertexNormals.push(L.clone(),L.clone(),L.clone(),L.clone()),P.materialIndex=d,c.faces.push(P),c.faceVertexUvs[0].push([new THREE.UV(g/b*a,(1-y/w)*f),new THREE.UV(g/b*a,(1-(y+1)/w)*f),new THREE.UV((g+1)/b*a,(1-(y+1)/w)*f),new THREE.UV((g+1)/b*a,(1-y/w)*f)])}}THREE.Geometry.call(this);var c=this,h=e/2,p=t/2,d=n/2;a=a||1,f=f||1,l=l||0;var v,m,g,y,b,w;if(o!==undefined){if(o instanceof Array)this.materials=o;else{this.materials=[];for(var E=0;E<6;E++)this.materials.push(o)}v=0,y=1,m=2,b=3,g=4,w=5}else this.materials=[];this.sides={px:!0,nx:!0,py:!0,ny:!0,pz:!0,nz:!0};if(u)for(var S in u)this.sides[S]!==undefined&&(this.sides[S]=u[S]);this.sides.px&&x("z","y",-1,-1,n,t,h,v),this.sides.nx&&x("z","y",1,-1,n,t,-h,y),this.sides.py&&x("x","z",-1,1,e,n,p,m,!0),this.sides.ny&&x("x","z",-1,-1,e,n,-p,b,!0),this.sides.pz&&x("x","y",1,-1,e,t,d,g),this.sides.nz&&x("x","y",-1,-1,e,t,-d,w),this.computeCentroids(),this.mergeVertices(),l&&this.computeVertexNormals()},BlockGeometry.prototype=Object.create(THREE.Geometry.prototype);var _textures=[];Controls=function(e,t,n){function v(e,t){return function(){t.apply(e,arguments)}}this.object=e,this.handlers=t||{},this.target=new THREE.Vector3(0,0,0),this.domElement=n!==undefined?n:document,this.movementSpeed=1,this.lookSpeed=.005,this.lookVertical=!0,this.autoForward=!1,this.mouseEnabled=!0,this.active=!0,this.constrainVerticalLook=!1,this.verticalMin=0,this.verticalMax=Math.PI,this.pointerLockEnabled=!1,this.mouseFallback=!1,this.mouseX=0,this.mouseY=0;var r=0,i=0,s=0,o=0,u=!1,a=!1,f=!1,l=!1,c=!1,h=!1,p=0,d=0;this.domElement!==document&&this.domElement.setAttribute("tabindex",-1),this.reset=function(){r=0,i=0},this.handleResize=function(){this.domElement===document?(p=window.innerWidth/2,d=window.innerHeight/2):(p=this.domElement.offsetWidth/2,d=this.domElement.offsetHeight/2)},this.onMouseDown=function(e){e.preventDefault(),this.domElement!==document&&this.domElement.focus(),this.pointerLockEnabled&&e.stopPropagation(),this.mouseEnabled&&this.handlers.mouse&&this.handlers.mouse(e.button)},this.onMouseUp=function(e){e.preventDefault(),this.pointerLockEnabled&&e.stopPropagation();if(this.mouseEnabled)switch(e.button){case 0:break;case 2:}},this.onMouseMove=function(e){function t(e,t,n){return e<t?t:e>n?n:e}this.pointerLockEnabled?(this.mouseX=e.movementX||e.webkitMovementX||e.mozMovementX||0,this.mouseY=e.movementY||e.webkitMovementY||e.mozMovementY||0,this.mouseX=t(this.mouseX*20,-600,600),this.mouseY=t(this.mouseY*20,-600,600)):this.domElement===document?(this.mouseX=e.pageX-p,this.mouseY=e.pageY-d):(this.mouseX=e.pageX-this.domElement.offsetLeft-p,this.mouseY=e.pageY-this.domElement.offsetTop-d)},this.onKeyDown=function(e){switch(e.keyCode){case 38:case 87:u=!0;break;case 37:case 65:f=!0;break;case 40:case 83:a=!0;break;case 39:case 68:l=!0;break;case 81:this.active=!this.active}},this.onKeyUp=function(e){switch(e.keyCode){case 38:case 87:u=!1;break;case 37:case 65:f=!1;break;case 40:case 83:a=!1;break;case 39:case 68:l=!1}},this.update=function(e){if(!this.active)return;var t=e*this.movementSpeed,n=this.mouseEnabled?e*this.lookSpeed:0,p=this.object.position;if(this.pointerLockEnabled||this.mouseFallback&&this.mouseX*this.mouseX+this.mouseY*this.mouseY>5e3)i+=this.mouseX*n,this.lookVertical&&(r-=this.mouseY*n);r=Math.max(-85,Math.min(85,r)),s=(90-r)*Math.PI/180,o=i*Math.PI/180,this.constrainVerticalLook&&(s=THREE.Math.mapLinear(s,0,Math.PI,this.verticalMin,this.verticalMax)),this.target.x=p.x+100*Math.sin(s)*Math.cos(o),this.target.y=p.y+100*Math.cos(s),this.target.z=p.z+100*Math.sin(s)*Math.sin(o),this.pointerLockEnabled&&(this.mouseX=0,this.mouseY=0),this.object.lookAt(this.target),u||this.autoForward&&!a?this.object.translateZ(-t):a&&this.object.translateZ(t),f?this.object.translateX(-t):l&&this.object.translateX(t),c?this.object.translateY(t):h&&this.object.translateY(-t)},this.domElement.addEventListener("contextmenu",function(e){e.preventDefault()},!1),this.domElement.addEventListener("mousemove",v(this,this.onMouseMove),!1),this.domElement.addEventListener("mousedown",v(this,this.onMouseDown),!1),this.domElement.addEventListener("mouseup",v(this,this.onMouseUp),!1),this.domElement.addEventListener("keydown",v(this,this.onKeyDown),!1),this.domElement.addEventListener("keyup",v(this,this.onKeyUp),!1),this.handleResize()};var assets={objects:{"rock-01":{collision:"sphere",mass:400,randScale:.3},"rock-02":{collision:"box",mass:400,randScale:.3},"rock-03":{collision:"box",mass:400,randScale:.3},"rock-04":{collision:"box",mass:500,randScale:.3},barrel:{collision:"cylinder",mass:250},box:{collision:"box",mass:150},"netted-jar":{collision:"cylinder",mass:100},"table-big":{collision:"box",mass:1e3},"table-old":{collision:"box",mass:800},"chair-01":{collision:"box",mass:200},"pillar-greek":{collision:"cylinder",mass:0}},materials:{"rock-01":{roughness:.15},"rock-02":{roughness:.15},"rock-03":{roughness:.15},"rock-04":{roughness:.15}},environments:{cave:{wall:["rock-01","rock-02","rock-03","rock-04"],floor:["sand-01","sand-02","sand-03","sand-04"],ceiling:["rock-01","rock-02","rock-03","rock-04"],objects:["rock-01","rock-02","rock-03","rock-04"]},mine:{wall:["rock-01","rock-02","rock-03","rock-04"],floor:["rock-01","rock-02","rock-03","rock-04"],ceiling:["rock-01","rock-02","rock-03","rock-04"],objects:["rock-01","rock-02","rock-03","rock-04","barrel","box","netted-jar","table-old"]},dungeon:{wall:["stone-01","stone-02","stone-03"],floor:["stone-floor-02","stone-floor-05"],ceiling:["stone-01"],objects:["barrel","box","netted-jar","table-old","chair-01"]},castle:{wall:["stone-01","tiles-01","tiles-02"],floor:["stone-floor-01","stone-floor-03","stone-floor-04","wood-floor-01"],ceiling:["stone-01"],objects:["barrel","netted-jar","table-big","chair-01"]},temple:{wall:["stone-01","tiles-01","tiles-02"],floor:["stone-floor-01","stone-floor-03","stone-floor-04","wood-floor-01"],ceiling:["stone-01"],objects:["pillar-greek","pillar-greek","netted-jar","table-old","chair-01"]}}},container,renderStats,physicsStats,pl,controls,scene,renderer,composer,renderTargetParametersRGBA,renderTargetParametersRGB,colorTarget,depthTarget,depthPassPlugin,lightManager,dungeon,clock=new THREE.Clock,cache=new Cache,passes={};$(document).ready(function(){function n(){requestAnimationFrame(n);var r=clock.getDelta();e.set(pl.camera.position.x,0,pl.camera.position.z),controls.update(r),t.set(pl.camera.position.x,0,pl.camera.position.z),t.subSelf(e),t.divideScalar(r*UNIT),e=pl.getLinearVelocity(),pl.setLinearVelocity({x:t.x,y:e.y<0?e.y:0,z:t.z}),scene.simulate(),controls.object.position.set(pl.position.x,pl.position.y+.5,pl.position.z),animate(r),lightManager.update(pl),renderer.clear(),CONFIG.postprocessing?(renderer.shadowMapEnabled=CONFIG.shadows,depthPassPlugin.enabled=!0,renderer.render(scene,pl.camera,composer.renderTarget2,!0),renderer.shadowMapEnabled=!1,depthPassPlugin.enabled=!1,composer.render(r)):renderer.render(scene,pl.camera),renderStats.update()}var e=new THREE.Vector3,t=new THREE.Vector3;init(),n()});