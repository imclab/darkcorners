<!DOCTYPE html>
<html lang="en">
<head>
	<title>Dungeon map editor</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
	<style>
		body { color: #ccc; background-color: #333; }
		canvas { background-color: #ccc; position: relative; }
		#thumbs { float: left; margin-right: 10px; }
		#exported { display: none; width: 640px; height: 480px; }
	</style>
	<script src="../libs/dat.gui.min.js"></script>
	<script src="../assets/assets.js"></script>
</head>
<body>
	<h3>Level editor</h3>
	<canvas id="canvas" width="640", height="640">
		<p>Oh noes, no &lt;canvas&gt;!</p>
	</canvas>
	<p>Left click to draw walls or place selected thing. Right click to erase.</p>
	<textarea id="exported"></textarea>
	<p>Material reference: hover over the image to see the name to put to the map properties.<p>
	<p>Currently you can't click them and the material cannot be set for individual tiles.</p>
	<table id="thumbs"></table>

	<script>
		window.requestAnimationFrame = window.requestAnimationFrame || window.webkitRequestAnimationFrame || window.mozRequestAnimationFrame || window.oRequestAnimationFrame || window.msRequestAnimationFrame;
		var canvas = document.getElementById("canvas");
		var w = 40, h = 40;
		var s = canvas.width / w;
		var ctx = canvas.getContext("2d");
		ctx.font = "bolder " + ((s*0.9)|0) + "px monospace";
		ctx.textBaseline = "middle";
		ctx.textAlign = "center";

		var i;
		var WALL = "#";
		var OPEN = ".";

		var editor = {
			drawGrid: true,
			drawTextures: false,
			hideLights: false,
			hideObjects: false
		};

		var level = {
			materials: {
				ceiling: "rock-01",
				wall: "stone-01",
				floor: "stone-floor-01"
			},
			roomHeight: 3,
			gridSize: 2,
			objects: [],
			lights: [],
			start: [ Math.floor(w/2)-0.5, Math.floor(h*0.25)-0.5 ],
			exit: [ Math.floor(w/2)-0.5, Math.floor(h*0.75)-0.5 ],
			width: w,
			depth: h,
			map: new Array(w * h)
		};

		for (i = 0; i < w * h; ++i) level.map[i] = OPEN;

		var materials = [ "rock-01", "rock-02", "rock-03", "rock-04", "sand-01", "sand-02", "sand-03", "sand-04", "stone-01", "stone-02", "stone-03", "stone-floor-01", "stone-floor-02", "stone-floor-03", "stone-floor-04", "stone-floor-05", "stone-floor-06", "tiles-01", "tiles-02", "wood-floor-01" ];
		var gtemplate = '<td><img id="%1" src="../assets/textures/thumbs/%1.jpg" alt="%1" title="%1"></img></td>';
		var gcols = 10;
		var gallery = "";
		for (i = 0; i < materials.length; ++i) {
			if (i % gcols === 0) gallery += '<tr>';
			gallery += gtemplate.replace(/%1/g, materials[i]);
			if (i % gcols == gcols-1) gallery += '</tr>';
		}
		document.getElementById("thumbs").innerHTML = gallery;
		var images = {};
		for (i = 0; i < materials.length; ++i)
			images[materials[i]] = document.getElementById(materials[i]);

		var objects = [];
		for (i in assets.objects) objects.push(i);
		var tools = {};

		tools.walls = {
			drawing: null,
			drawWalls: function() { currentTool = tools.walls; },
			mousedown: function(e) {
				if (e.button == 0) tools.walls.drawing = WALL;
				else if (e.button == 2) tools.walls.drawing = OPEN;
				else return;
				put(e._x, e._y, tools.walls.drawing);
			},
			mousemove: function(e) {
				if (tools.walls.drawing) put(e._x, e._y, tools.walls.drawing);
			},
			mouseup: function(e) {
				tools.walls.drawing = null;
			}
		};
		var currentTool = tools.walls;

		tools.start = {
			placeStart: function() { currentTool = tools.start; },
			mousedown: function(e) {
				if (e.button == 0) {
					put(e._x, e._y, OPEN);
					level.start[0] = e._x / s;
					level.start[1] = e._y / s;
				}
			}
		};

		tools.exit = {
			placeExit: function() { currentTool = tools.exit; },
			mousedown: function(e) {
				if (e.button == 0) {
					put(e._x, e._y, OPEN);
					level.exit[0] = e._x / s;
					level.exit[1] = e._y / s;
				}
			}
		};

		tools.light = {
			addLight: function() { currentTool = tools.light; },
			mousedown: function(e) {
				if (e.button == 0) {
					level.lights.push({ position: { x: e._x / s, y: 2, z: e._y / s } });
				} else if (e.button == 2) {
					for (var i = 0; i < level.lights.length; ++i) {
						if (Math.abs(level.lights[i].position.x - e._x / s) < 0.75 &&
							Math.abs(level.lights[i].position.z - e._y / s) < 0.75) {
								level.lights.splice(i, 1);
								console.log("hit");
								break;
						}
					}
				}
			}
		};

		tools.object = {
			object: "barrel",
			addObject: function() { currentTool = tools.object; },
			mousedown: function(e) {
				if (e.button == 0) {
					level.objects.push({
						name: tools.object.object,
						position: { x: e._x / s, y: null, z: e._y / s }
					});
				} else if (e.button == 2) {
					for (var i = 0; i < level.objects.length; ++i) {
						if (Math.abs(level.objects[i].position.x - e._x / s) < 0.75 &&
							Math.abs(level.objects[i].position.z - e._y / s) < 0.75) {
								level.objects.splice(i, 1);
								break;
						}
					}
				}
			}
		};

		function put(x, y, what) {
			x = Math.floor(x / s);
			y = Math.floor(y / s);
			if (x < 0 || x > w-1 || y < 0 || y > h-1) return;
			level.map[y * w + x] = what;
		}

		function render() {
			requestAnimationFrame(render);
			ctx.clearRect(0, 0, canvas.width, canvas.height);
			// Grid and walls
			ctx.strokeStyle = "#999";
			ctx.fillStyle = "#640";
			for (var j = 0; j < h; ++j) {
				for (var i = 0; i < w; ++i) {
					if (editor.drawTextures) {
						if (level.map[j * w + i] == WALL)
							ctx.drawImage(images[level.materials.wall], i * s, j * s, s, s);
						else ctx.drawImage(images[level.materials.floor], i * s, j * s, s, s);
					} else {
						if (level.map[j * w + i] == WALL)
							ctx.fillRect(i * s, j * s, s, s);
					}
					if (editor.drawGrid)
						ctx.strokeRect(i * s, j * s, s, s);
				}
			}
			// Lights
			if (!editor.hideLights) {
				ctx.fillStyle = "#ff0";
				for (i = 0; i < level.lights.length; ++i) {
					ctx.beginPath();
					ctx.arc(level.lights[i].position.x * s, level.lights[i].position.z * s, s * 0.25, 0, Math.PI * 2);
					ctx.fill();
				}
			}
			// Objects
			if (!editor.hideObjects) {
				ctx.fillStyle = "#006";
				for (i = 0; i < level.objects.length; ++i) {
					ctx.beginPath();
					ctx.arc(level.objects[i].position.x * s, level.objects[i].position.z * s, s * 0.4, 0, Math.PI * 2);
					ctx.fill();
				}
			}
			// Start
			ctx.fillStyle = "#229";
			ctx.fillRect(level.start[0] * s + 1 - s/2, level.start[1] * s + 1 - s/2, s - 2, s - 2);
			ctx.fillStyle = "#66f";
			ctx.fillText("S", level.start[0] * s, level.start[1] * s);
			// Exit
			ctx.fillStyle = "#922";
			ctx.fillRect(level.exit[0] * s + 1 - s/2, level.exit[1] * s + 1 - s/2, s - 2, s - 2);
			ctx.fillStyle = "#f66";
			ctx.fillText("E", level.exit[0] * s, level.exit[1] * s);
		}

		function check() {
			if (!level.lights.length) alert("Warning: There are no lights in the level.");
		}

		function exportBase64() {
			check();
			var b64 = window.btoa(JSON.stringify(level, null, '\t'));
			document.getElementById("exported").value = b64;
			document.getElementById("exported").style.display = "block";
		}

		function exportJSON() {
			check();
			document.getElementById("exported").value = JSON.stringify(level, null, '\t');
			document.getElementById("exported").style.display = "block";
		}

		function importLevel() {
			var json = prompt("Paste here the level JSON to import");
			if (!json || !json.length) return;
			try {
				json = JSON.parse(json);
			} catch (err) {
				alert("Import error: " + err);
				return;
			}
			level = json;
			document.getElementById("exported").value = "";
			document.getElementById("exported").style.display = "none";
		}

		function test() {
			var url = "../game_dev.html?level=" + window.btoa(JSON.stringify(level, null, '\t'));
			window.open(url, "_blank");
		}

		var gui = new dat.GUI();
		gui.add(tools.walls, "drawWalls");
		var guiMap = gui.addFolder("Map properties");
		guiMap.add(level.materials, "ceiling", materials);
		guiMap.add(level.materials, "wall", materials);
		guiMap.add(level.materials, "floor", materials);
		guiMap.add(level, "roomHeight", 2, 10).step(0.5);
		guiMap.add(level, "gridSize", 1, 4).step(1);
		guiMap.add(tools.start, "placeStart");
		guiMap.add(tools.exit, "placeExit");
		var guiLights = gui.addFolder("Lights");
		guiLights.add(tools.light, "addLight");
		var guiObjects = gui.addFolder("Objects");
		guiObjects.add(tools.object, "object", objects);
		guiObjects.add(tools.object, "addObject");
		var guiEditor = gui.addFolder("Editor options");
		guiEditor.add(editor, "drawGrid");
		guiEditor.add(editor, "drawTextures");
		guiEditor.add(editor, "hideLights");
		guiEditor.add(editor, "hideObjects");
		gui.add(window, "importLevel");
		gui.add(window, "exportBase64");
		gui.add(window, "exportJSON");
		gui.add(window, "test");

		function mouseHandler(e) {
			e._x = e.layerX || e.offsetX || 0;
			e._y = e.layerY || e.offsetY || 0;
			if (currentTool[e.type]) currentTool[e.type](e);
			return false;
		}

		canvas.addEventListener("mousedown", mouseHandler, false);
		canvas.addEventListener("mouseup", mouseHandler, false);
		canvas.addEventListener("mousemove", mouseHandler, false);
		document.oncontextmenu = function() { return false; }
		window.addEventListener("load", render);

	</script>
</body>
</html>
