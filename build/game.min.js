"use strict";function Cache(){this.models={},this.modelMaterials={},this.geometries={},this.materials={};var e=this,t=new THREE.JSONLoader(!0);t.statusDomElement.style.left="0px",t.statusDomElement.style.fontSize="1.8em",t.statusDomElement.style.width="auto",t.statusDomElement.style.color="#c00",document.body.appendChild(t.statusDomElement);var n=0;this.loadModel=function(r,i,s){var o=this.models[r];o?o instanceof Array?o.push(i):i(o,this.modelMaterials[r]):(this.models[r]=[i],t.statusDomElement.style.display="block"
,n++,t.load(r,function(i,s){var o=e.models[r];for(var u=0;u<o.length;++u)o[u](i,s);e.models[r]=i,e.modelMaterials[r]=s,n--,n===0&&(t.statusDomElement.style.display="none")},s))},this.getGeometry=function(e,t){var n=this.geometries[e];return n?n:(this.geometries[e]=n=t(),n)},this.getMaterial=function(e){var t=this.materials[e];return t?t:(this.materials[e]=t=createMaterial(e),t)}}function PlaneGeometry(e,t,n,r,i,s,o,u){THREE.Geometry.call(this);var a,f,l=e/2,c=t/2,h=n||1,p=r||1,d=h+1,v=p+1,m=e/h,g=t/p,y=new THREE
.Vector3,b=new THREE.Vector3,w=new THREE.Vector3;s=s||1,o=o||1,u=u||0,i=i||"pz";switch(i){case"nx":y.x=-1,b.z=-1,w.y=1;break;case"px":y.x=1,b.z=-1,w.y=-1;break;case"ny":y.y=-1,b.x=-1,w.z=1;break;case"py":y.y=1,b.x=-1,w.z=-1;break;case"nz":y.z=-1,b.x=1,w.y=1;break;case"pz":y.z=1,b.x=1,w.y=-1;break;default:console.error("Unknown plane direction "+i)}var E=new THREE.Vector3;for(f=0;f<v;f++)for(a=0;a<d;a++){var S=a*m-l,x=f*g-c,T=new THREE.Vector3(S*b.x,S*b.y,S*b.z);T.set(T.x+x*w.x,T.y+x*w.y,T.z+x*w.z),u&&a>0&&a<
d-1&&(E.copy(y),E.multiplyScalar(-u+Math.random()*u*2),T.addSelf(E)),this.vertices.push(T)}for(f=0;f<p;f++)for(a=0;a<h;a++){var N=a+d*f,C=a+d*(f+1),k=a+1+d*(f+1),L=a+1+d*f,A=new THREE.Face4(N,C,k,L);A.normal.copy(y),A.vertexNormals.push(y.clone(),y.clone(),y.clone(),y.clone()),A.materialIndex=0,this.faces.push(A),this.faceVertexUvs[0].push([new THREE.Vector2(a/h*s,(1-f/p)*o),new THREE.Vector2(a/h*s,(1-(f+1)/p)*o),new THREE.Vector2((a+1)/h*s,(1-(f+1)/p)*o),new THREE.Vector2((a+1)/h*s,(1-f/p)*o)])}this.computeCentroids
(),u&&this.computeVertexNormals(),this.dynamic=!1}function BlockGeometry(e,t,n,r,i,s,o,u,a,f,l){function S(e,t,n,o,u,h,p,d,v){var m,g,y,b=r||1,w=i||1,E=u/2,S=h/2,x=c.vertices.length;if(e==="x"&&t==="y"||e==="y"&&t==="x")m="z";else if(e==="x"&&t==="z"||e==="z"&&t==="x")m="y",w=s||1;else if(e==="z"&&t==="y"||e==="y"&&t==="z")m="x",b=s||1;var T=b+1,N=w+1,C=u/b,k=h/w,L=new THREE.Vector3;L[m]=p>0?1:-1,v&&(L[m]*=-1);for(y=0;y<N;y++)for(g=0;g<T;g++){var A=new THREE.Vector3;A[e]=(g*C-E)*n,A[t]=(y*k-S)*o,A[m]=p,l&&g>0&&
g<T-1&&(A[m]+=-l+Math.random()*l*2),c.vertices.push(A)}for(y=0;y<w;y++)for(g=0;g<b;g++){var O=g+T*y,M=g+T*(y+1),_=g+1+T*(y+1),D=g+1+T*y,P=new THREE.Face4(O+x,M+x,_+x,D+x);P.normal.copy(L),P.vertexNormals.push(L.clone(),L.clone(),L.clone(),L.clone()),P.materialIndex=d,c.faces.push(P),c.faceVertexUvs[0].push([new THREE.Vector2(g/b*a,(1-y/w)*f),new THREE.Vector2(g/b*a,(1-(y+1)/w)*f),new THREE.Vector2((g+1)/b*a,(1-(y+1)/w)*f),new THREE.Vector2((g+1)/b*a,(1-y/w)*f)])}}THREE.Geometry.call(this);var c=this,h=e/2,p=
t/2,d=n/2;a=a||1,f=f||1,l=l||0;var v,m,g,y,b,w;o?(v=0,y=1,m=2,b=3,g=4,w=5):v=y=m=b=g=w=0,this.sides={px:!0,nx:!0,py:!0,ny:!0,pz:!0,nz:!0};if(u)for(var E in u)this.sides[E]!==undefined&&(this.sides[E]=u[E]);this.sides.px&&S("z","y",-1,-1,n,t,h,v),this.sides.nx&&S("z","y",1,-1,n,t,-h,y),this.sides.py&&S("x","z",-1,1,e,n,p,m,!0),this.sides.ny&&S("x","z",-1,-1,e,n,-p,b,!0),this.sides.pz&&S("x","y",1,-1,e,t,d,g),this.sides.nz&&S("x","y",-1,-1,e,t,-d,w),this.computeCentroids(),this.mergeVertices(),l&&this.computeVertexNormals
(),this.dynamic=!1}function LightManager(e){function r(e,t){var n=t.x-e.x,r=t.z-e.z;return n*n+r*r}e=e||{},this.maxLights=e.maxLights||4,this.maxShadows=e.maxShadows||2,this.lights=[],this.shadows=[],this.addLight=function(e){this.lights.push(e)},this.addShadow=function(e){this.shadows.push(e)};var t=new THREE.Vector2,n=new THREE.Vector2;this.update=function(e){function i(r,i){return t.set(r.x-e.position.x,r.z-e.position.z).normalize(),n.set(i.x-e.position.x,i.z-e.position.z).normalize(),Math.acos(t.dot(n))}
function s(t,n){return r(t.position,e.position)-r(n.position,e.position)}var o,u=0;if(this.maxLights<this.lights.length){this.lights.sort(s);for(o=0;o<this.lights.length;++o)u<this.maxLights&&(i(this.lights[o].position,controls.target)<Math.PI*.4||r(this.lights[o].position,e.position)<1.5*this.lights[o].distance*this.lights[o].distance)?(this.lights[o].visible=!0,++u):this.lights[o].visible=!1}if(this.maxShadows<this.shadows.length){this.shadows.sort(s);for(o=0;o<this.shadows.length;++o)o<this.maxShadows?this
.shadows[o].castShadow=!0:this.shadows[o].castShadow=!1}}}function AnimationManager(){this.anims=[]}function AIManager(){function i(i,s,o){i.updateMatrixWorld(),i.matrixRotationWorld.extractRotation(i.matrixWorld),i.matrixRotationWorld.multiplyVector3(e.set(0,0,1)),t.copy(s),t.subSelf(i.position),t.y=0,t.normalize();var u=Math.atan2(e.z,e.x)-Math.atan2(t.z,t.x);u>Math.PI&&(u-=Math.PI*2);var a=n*u;return a>r&&(a=r),a<-r&&(a=-r),i.setAngularVelocity(e.set(0,a,0)),i.position.distanceToSquared(s)>=o?(Math.abs(u)<
Math.PI/4?i.setLinearVelocity(t.multiplyScalar(i.speed)):i.setLinearVelocity(t.set(0,0,0)),i.mesh&&(i.mesh.animate=!0),!1):(i.setLinearVelocity(t.set(0,0,0)),i.mesh&&(i.mesh.animate=!1),!0)}var e=new THREE.Vector3,t=new THREE.Vector3,n=10,r=Math.PI;this.process=function(){var t,n,r=dungeon.level.gridSize;for(t=0;t<dungeon.monsters.length;++t){var s=dungeon.monsters[t];if(s.dead)continue;if(dungeon.level.map.raycast(s.position.x/r,s.position.z/r,pl.position.x/r,pl.position.z/r))s.activated=!0,s.waypoints=null
,i(s,pl.position,12);else if(s.activated&&!s.waypoints){var o=dungeon.pathFinder.findPath(s.position.x/r|0,s.position.z/r|0,pl.position.x/r|0,pl.position.z/r|0,dungeon.grid.clone());s.waypoints=[];for(n=0;n<o.length;++n)e.set((o[n][0]+.5)*r,s.position.y,(o[n][1]+.5)*r),s.waypoints.push(e.clone())}s.waypoints&&(s.waypoints.length?i(s,s.waypoints[0],1)&&s.waypoints.splice(0,1):s.waypoints=null)}}}function Sound(e,t){typeof e=="string"&&(e=[e]),t=t||1,this.sampleIndex=0,this.samples=[];while(this.samples.length<
t)for(var n=0;n<e.length;++n)this.samples.push(new Audio("assets/sounds/"+e[n]));this.play=function(e){if(!CONFIG.sounds)return;try{var t=this.samples[this.sampleIndex];window.chrome?t.load():t.currentTime=0,e!==undefined&&(t.volume=e),t.play(),this.sampleIndex=(this.sampleIndex+1)%this.samples.length}catch(n){}}}function SoundManager(){var e={},t;for(var n in assets.sounds)e[n]=new Sound(assets.sounds[n],5);this.play=function(t){e[t].play()},this.playSpatial=function(t,n,r){var i=pl.camera.position.distanceTo
(n);i<r&&e[t].play(1-i/r)},this.playMusic=function(e){this.stopMusic(),t=new Audio("assets/music/"+e+".ogg"),t.loop=!0,t.play()},this.stopMusic=function(){t&&t.pause()}}function _resize(e,t){_resizeCanvas.width=e.width*t|0,_resizeCanvas.height=e.height*t|0,_resizeCanvas.style.width=_resizeCanvas.width+"px",_resizeCanvas.style.height=_resizeCanvas.height+"px",_resizeCtx.drawImage(e,0,0,_resizeCanvas.width,_resizeCanvas.height),e.sized=!0,e.src=_resizeCanvas.toDataURL("image/png")}function loadTexture(e,t){t=t||
{};var n=new Image;n.sized=!0,n.onload=function(){n.sized?r.needsUpdate=!0:_resize(n,.0625)},n.src=e;var r=new THREE.Texture(n,new THREE.UVMapping,THREE.RepeatWrapping,THREE.RepeatWrapping,CONFIG.linearTextureFilter?THREE.LinearFilter:THREE.NearestFilter,CONFIG.linearTextureFilter?THREE.LinearMipMapLinearFilter:THREE.NearestFilter,t.alpha?THREE.RGBAFormat:THREE.RGBFormat,THREE.UnsignedByteType,CONFIG.anisotropy);return _textures.push(r),r}function updateTextures(){for(var e=0;e<_textures.length;++e)_textures
[e].magFilter=CONFIG.linearTextureFilter?THREE.LinearFilter:THREE.NearestFilter,_textures[e].minFilter=CONFIG.linearTextureFilter?THREE.LinearMipMapLinearFilter:THREE.NearestFilter,_textures[e].anisotropy=CONFIG.anisotropy,_textures[e].needsUpdate=!0;updateConfig()}function fixAnisotropy(e,t){function n(e){if(!e)return;e.anisotropy=t,e.needsUpdate=!0}if(!e)return;t=t||CONFIG.anisotropy,e instanceof THREE.ShaderMaterial?(n(e.uniforms.tDiffuse.value),n(e.uniforms.tNormal.value),n(e.uniforms.tSpecular.value),n(
e.uniforms.tAO.value),n(e.uniforms.tCube.value),n(e.uniforms.tDisplacement.value)):(n(e.map),n(e.normalMap),n(e.specularMap),n(e.lightMap))}function updateMaterials(){var e;for(e in cache.materials){if(!cache.materials.hasOwnProperty(e))continue;cache.materials[e].needsUpdate=!0}for(e in cache.modelMaterials){var t=cache.modelMaterials[e];for(var n=0;n<t.length;++n)t[n].needsUpdate=!0}updateConfig()}function createMaterial(e){var t="assets/textures/";CONFIG.textureQuality===0?t="assets/textures-256/":CONFIG.
textureQuality==1&&(t="assets/textures-512/");var n=11184810,r=11184810,i=16777215,s=30,o=1;return new THREE.MeshPhongMaterial({ambient:n,diffuse:r,specular:i,shininess:s,perPixel:!0,map:loadTexture(t+e+".jpg"),specularMap:CONFIG.specularMapping?loadTexture(t+"specular/"+e+".jpg"):undefined,normalMap:CONFIG.normalMapping?loadTexture(t+"normal/"+e+".jpg"):undefined,normalScale:new THREE.Vector2(CONFIG.normalScale,CONFIG.normalScale)})}function dumpInfo(){var e=renderer.context,t={Version:e.getParameter(e.VERSION
),"Shading language":e.getParameter(e.SHADING_LANGUAGE_VERSION),Vendor:e.getParameter(e.VENDOR),Renderer:e.getParameter(e.RENDERER),"Max varying vectors":e.getParameter(e.MAX_VARYING_VECTORS),"Max vertex attribs":e.getParameter(e.MAX_VERTEX_ATTRIBS),"Max vertex uniform vectors":e.getParameter(e.MAX_VERTEX_UNIFORM_VECTORS),"Max fragment uniform vectors":e.getParameter(e.MAX_FRAGMENT_UNIFORM_VECTORS),"Max renderbuffer size":e.getParameter(e.MAX_RENDERBUFFER_SIZE),"Max texture size":e.getParameter(e.MAX_TEXTURE_SIZE
),"Max cube map texture size":e.getParameter(e.MAX_CUBE_MAP_TEXTURE_SIZE),"Max texture image units":e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS),"Max vertex texture units":e.getParameter(e.MAX_VERTEX_TEXTURE_IMAGE_UNITS),"Max combined texture units":e.getParameter(e.MAX_COMBINED_TEXTURE_IMAGE_UNITS),"Max viewport dims":e.getParameter(e.MAX_VIEWPORT_DIMS)[0]+"x"+e.getParameter(e.MAX_VIEWPORT_DIMS)[1]};console.log("WebGL info: ",t)}function screenshot(e,t){var n=t?"image/jpeg":"image/png",r=renderer.domElement.toDataURL
(n);e||(r=r.replace(n,"image/octet-stream")),window.open(r,"_blank")}function Profiler(e){e=e||"Profiling",e+=": ",this.start=function(){this.time=performance.now()},this.end=function(){var t=performance.now()-this.time;console.log(e+t+"ms")},this.start()}function diagnose(){var e=[],t=[],n=[];scene.traverse(function(r){t.push(r),r.geometry&&e.push(r.geometry);if(r.material)if(r.material.materials)for(var i=0;i<r.material.materials.length;++i)n.push(r.material.materials[i]);else n.push(r.material)}),console.
log("Geometries",e),console.log("Meshes",t),console.log("Materials",n),console.log("GeometryIdCount:",THREE.GeometryIdCount,"Object3DIdCount:",THREE.Object3DIdCount,"MaterialIdCount:",THREE.MaterialIdCount),console.log("GeometryCount:",e.length,"MeshCount:",t.length,"MaterialCount:",n.length)}function particleSystemCreator(e,t,n){var r,i=new THREE.Geometry;for(r=0;r<e.nParticles();r++)i.vertices.push(new THREE.Vector3);i.colors=new Array(e.nParticles());for(r=0;r<e.nParticles();r++)i.colors[r]=new THREE.Color
;var s=new THREE.ParticleSystem(i,n);return s.dynamic=!0,s.sortParticles=!0,s.position=t,scene.add(s),s}function createSimpleFire(e){var t=Fireworks.createEmitter({nParticles:30});return t.effectsStackBuilder().spawnerSteadyRate(20).position(Fireworks.createShapeSphere(0,0,0,.1)).velocity(Fireworks.createShapePoint(0,1,0)).lifeTime(.3,.6).renderToThreejsParticleSystem({particleSystem:particleSystemCreator(t,e,particleMaterials.simpleFire)}).back().start(),t}function createTeleporterParticles(e){var t=Fireworks
.createEmitter({nParticles:30});return t.effectsStackBuilder().spawnerSteadyRate(20).position(Fireworks.createShapeSphere(0,0,0,.3)).velocity(Fireworks.createShapePoint(0,1,0)).lifeTime(.6,1.2).renderToThreejsParticleSystem({particleSystem:particleSystemCreator(t,e,particleMaterials.teleporter)}).back().start(),t}function createTexturedFire(e){var t=8,n=128,r=Fireworks.createEmitter({nParticles:5});return r.effectsStackBuilder().spawnerSteadyRate(15).position(Fireworks.createShapeSphere(0,.05,0,.05)).velocity
(Fireworks.createShapePoint(0,1.5,0)).lifeTime(.1,.3).friction(.99).createEffect("scale",{origin:n/1e3,factor:1.02}).onBirth(function(e){var t=this.opts.origin;e.threejsObject3D.object3d.scale.set(t*1.5,t*4)}).onUpdate(function(e,t){e.threejsObject3D.object3d.scale.multiplyScalar(this.opts.factor)}).back().createEffect("rotation").onBirth(function(e){e.threejsObject3D.object3d.rotation=Math.random()*Math.PI*2}).back().createEffect("opacity",{gradient:_fireGradient}).onUpdate(function(e){var t=e.lifeTime.normalizedAge
();e.threejsObject3D.object3d.opacity=this.opts.gradient.get(t)}).back().renderToThreejsObject3D({container:e,create:function(){var e=new THREE.Sprite(particleMaterials.texturedFire.clone());return e.material.uvScale.set(1,1/t),e}}).createEffect("updateSpritesheet").onUpdate(function(e,n){var r=e.lifeTime.normalizedAge(),i=Math.floor(r*t),s=i*1/t;e.threejsObject3D.object3d.material.uvOffset.set(0,s)}).back().back().start(),r}function Controls(e,t,n){function v(e,t){return function(){t.apply(e,arguments)}}this
.object=e,this.handlers=t||{},this.target=new THREE.Vector3(0,0,0),this.domElement=n!==undefined?n:document,this.movementSpeed=1,this.lookSpeed=.005,this.lookVertical=!0,this.autoForward=!1,this.mouseEnabled=!0,this.active=!0,this.constrainVerticalLook=!1,this.verticalMin=0,this.verticalMax=Math.PI,this.pointerLockEnabled=!1,this.mouseFallback=!1,this.mouseX=0,this.mouseY=0;var r=0,i=0,s=0,o=0,u=!1,a=!1,f=!1,l=!1,c=!1,h=!1,p=0,d=0;this.domElement!==document&&this.domElement.setAttribute("tabindex",-1),this.setYAngle=
function(e){i=e},this.reset=function(){r=0,i=0},this.handleResize=function(){this.domElement===document?(p=window.innerWidth/2,d=window.innerHeight/2):(p=this.domElement.offsetWidth/2,d=this.domElement.offsetHeight/2)},this.onMouseDown=function(e){e.preventDefault(),this.domElement!==document&&this.domElement.focus(),this.pointerLockEnabled&&e.stopPropagation(),this.mouseEnabled&&this.active&&this.handlers.mouse&&this.pointerLockEnabled&&this.handlers.mouse(e.button)},this.onMouseUp=function(e){e.preventDefault
(),this.pointerLockEnabled&&e.stopPropagation();if(this.mouseEnabled&&this.active)switch(e.button){case 0:break;case 2:}},this.onMouseMove=function(e){function t(e,t,n){return e<t?t:e>n?n:e}if(!this.mouseEnabled||!this.active)return;if(this.pointerLockEnabled){if(e.mozMovementX===0&&e.mozMovementY===0)return;this.mouseX=e.movementX||e.webkitMovementX||e.mozMovementX||0,this.mouseY=e.movementY||e.webkitMovementY||e.mozMovementY||0,this.mouseX=t(this.mouseX*20,-600,600),this.mouseY=t(this.mouseY*20,-600,600)}else this
.domElement===document?(this.mouseX=e.pageX-p,this.mouseY=e.pageY-d):(this.mouseX=e.pageX-this.domElement.offsetLeft-p,this.mouseY=e.pageY-this.domElement.offsetTop-d)},this.onKeyDown=function(e){switch(e.keyCode){case 38:case 87:u=!0;break;case 37:case 65:f=!0;break;case 40:case 83:a=!0;break;case 39:case 68:l=!0;break;case 82:reload();break;case 70:pl.shadow.visible=!pl.shadow.visible;break;case 123:screenshot(!0)}},this.onKeyUp=function(e){switch(e.keyCode){case 38:case 87:u=!1;break;case 37:case 65:f=!1;
break;case 40:case 83:a=!1;break;case 39:case 68:l=!1}},this.update=function(e){if(!this.active)return;var t=e*this.movementSpeed,n=this.mouseEnabled?e*this.lookSpeed:0,p=this.object.position;if(this.pointerLockEnabled||this.mouseFallback&&this.mouseX*this.mouseX+this.mouseY*this.mouseY>5e3)i+=this.mouseX*n,this.lookVertical&&(r-=this.mouseY*n);r=Math.max(-85,Math.min(85,r)),s=(90-r)*Math.PI/180,o=i*Math.PI/180,this.constrainVerticalLook&&(s=THREE.Math.mapLinear(s,0,Math.PI,this.verticalMin,this.verticalMax)
),this.target.x=p.x+100*Math.sin(s)*Math.cos(o),this.target.y=p.y+100*Math.cos(s),this.target.z=p.z+100*Math.sin(s)*Math.sin(o),this.pointerLockEnabled&&(this.mouseX=0,this.mouseY=0),this.object.lookAt(this.target),u||this.autoForward&&!a?this.object.translateZ(-t):a&&this.object.translateZ(t),f?this.object.translateX(-t):l&&this.object.translateX(t),c?this.object.translateY(t):h&&this.object.translateY(-t)},this.domElement.addEventListener("contextmenu",function(e){e.preventDefault()},!1),this.domElement.addEventListener
("mousemove",v(this,this.onMouseMove),!1),this.domElement.addEventListener("mousedown",v(this,this.onMouseDown),!1),this.domElement.addEventListener("mouseup",v(this,this.onMouseUp),!1),this.domElement.addEventListener("keydown",v(this,this.onKeyDown),!1),this.domElement.addEventListener("keyup",v(this,this.onKeyUp),!1),this.handleResize()}function Map(e,t,n){function o(t,n,r,i,s,u){var a=t.get(n,r);if(a!=i&&a!=u)return;a!=u&&(t.map[r*e+n]=s),o(t,n-1,r,i,s,u),o(t,n+1,r,i,s,u),o(t,n,r-1,i,s,u),o(t,n,r+1,i,s,u
)}function u(e,t,n,r){var i=n-e,s=r-t;return i*i+s*s}this.map=new Array(e*t);if(n&&n.length&&n instanceof Array)for(var r=0;r<t;++r)for(var i=0;i<e;++i)this.map[r*e+i]=n[r][i];else if(n)for(var s=0;s<e*t;++s)this.map[s]=n;this.get=function(n,r,i){return n<0||n>=e||r<0||r>=t?i||null:this.map[r*e+n]},this.put=function(n,r,i){if(n<0||n>=e||r<0||r>=t)return;this.map[r*e+n]=i},this.toJSON=function(){var n=new Array(t);for(var r=0;r<t;++r){n[r]="";for(var i=0;i<e;++i)n[r]+=this.map[r*e+i]}return n},this.replace=function(
n,r){for(var i=0;i<t;++i)for(var s=0;s<e;++s)this.map[i*e+s]==n&&(this.map[i*e+s]=r)},this.fill=function(e,t,n,r,i){o(this,e,t,n,r,i)},this.raycast=function(t,n,r,i,s){s=s||.5;var o=Math.atan2(i-n,r-t),a=Math.cos(o)*s,f=Math.sin(o)*s;while(u(t,n,r,i)>s*s){if(this.map[(n|0)*e+(t|0)]==WALL)return!1;t+=a,n+=f}return!0},this.getWalkableMatrix=function(){var n=new Array(t);for(var r=0;r<t;++r){n[r]=[];for(var i=0;i<e;++i)n[r].push(this.map[r*e+i]==WALL?1:0)}return n}}function MapGen(){function t(e,t,n){if(!t.length
)return!1;n=n?n*n:1e-6;for(var r=0;r<t.length;++r){var i=t[r].position.x-e.x,s=t[r].position.z-e.z;if(i*i+s*s<=n)return!0}return!1}function n(e,t){var n=0;return n+=t.get(e.x-1,e.z)==WALL?1:0,n+=t.get(e.x+1,e.z)==WALL?1:0,n+=t.get(e.x,e.z-1)==WALL?1:0,n+=t.get(e.x,e.z+1)==WALL?1:0,n==2}var e=this;this.generateMap=function(e){var t=e.width=rand(25,35),n=e.depth=rand(25,35);e.map=new Map(t,n,WALL);var r,i;e.env=randProp(assets.environments),e.materials={floor:randElem(e.env.floor),ceiling:randElem(e.env.ceiling
),wall:randElem(e.env.wall)};var s=rand(3,4),o=Math.floor(t*n/(s*s*4)),u=rand(s+1,t-s-1),a=rand(s+1,n-s-1),f,l,c,h;for(var p=0;p<o;++p){var d=rand(2,s),v=rand(2,s),m=u-rand(0,d-1),g=a-rand(0,v-1);for(i=g;i<g+v;++i)for(r=m;r<m+d;++r)e.map.put(r,i,OPEN);f=u,l=a;if(p==o-1)break;do u=rand(s+1,t-s-1),a=rand(s+1,n-s-1);while(e.map.get(u,a)==WALL&&Math.abs(f-u)+Math.abs(l-a)>=30);c=u<f;for(r=c?u:f;r<(c?f:u);++r)e.map.put(r,l,OPEN);h=a<l;for(i=h?a:l;i<(h?l:a);++i)e.map.put(u,i,OPEN)}e.floorCount=0;for(a=0;a<n;++a)for(
u=0;u<t;++u)e.map.get(u,a)==OPEN&&e.floorCount++;do e.start[0]=rand(1,t-2),e.start[1]=rand(1,n-2);while(e.map.get(e.start[0],e.start[1])==WALL);do e.exit[0]=rand(1,t-2),e.exit[1]=rand(1,n-2);while(e.map.get(e.exit[0],e.exit[1])==WALL);e.exit[0]+=.5,e.exit[1]+=.5},this.generateLights=function(e){var n=Math.floor(e.floorCount/20),r=new THREE.Vector3,i=0;while(i<n){r.x=rand(0,e.width-1),r.z=rand(0,e.depth-1);if(e.map.get(r.x,r.z)==WALL)continue;var s=rand(0,3)*Math.PI*.5,o=Math.round(Math.cos(s)),u=-Math.round(
Math.sin(s));while(e.map.get(r.x,r.z,WALL)!=WALL)r.x+=o,r.z+=u;r.x=r.x-.6*o+.5,r.z=r.z-.6*u+.5,r.y=e.roomHeight*.7;if(t(r,e.lights,4.1))continue;++i,e.lights.push({position:{x:r.x,y:r.y,z:r.z},target:{x:r.x-o*1.1,y:r.y-1,z:r.z-u*1.1}})}},this.generateObjects=function(e){var r=Math.floor(e.floorCount/8),i=new THREE.Vector3,s=0;while(s<r){i.x=rand(0,e.width-1),i.z=rand(0,e.depth-1);if(e.map.get(i.x,i.z)==WALL)continue;if(n(i,e.map))continue;i.x+=.5,i.z+=.5,i.y=null;if(t(i,e.objects,1.4))continue;++s;var o=randElem
(e.env.objects);e.objects.push({name:o,position:{x:i.x,y:i.y,z:i.z}})}},this.generate=function(){var e={map:[],objects:[],lights:[],gridSize:2,roomHeight:3,start:[0,0],exit:[0,0]};return this.generateMap(e),this.generateLights(e),this.generateObjects(e),e}}function randProp(e){var t,n=0;for(var r in e)Math.random()<1/++n&&(t=r);return e[t]}function randElem(e){return e[Math.random()*e.length|0]}function rand(e,t){return e+Math.floor(Math.random()*(t-e+1))}function randf(e,t){return e+Math.random()*(t-e)}function Dungeon
(e,t,n){function f(t,n,i,s){return function(a,f){s||(s={});var l,c=s.mass||0;s.character&&(c=1e5);var h=1;s.randScale&&(h+=randf(-s.randScale,s.randScale),c*=h),a.boundingBox||a.computeBoundingBox(),a.dynamic=!1;for(var p=0;p<f.length;++p)fixAnisotropy(f[p]),f[p].normalScale&&f[p].normalScale.set(CONFIG.normalScale,CONFIG.normalScale),f[p].ambient.setRGB(.5,.5,.5),f[p].color.setRGB(.6,.6,.6);var d=f.length>1?new THREE.MeshFaceMaterial(f):f[0];if(s.collision){var v=Physijs.createMaterial(d,.7,.2);if(s.collision=="plane"
)l=new Physijs.PlaneMesh(a,v,c);else if(s.collision=="box")l=new Physijs.BoxMesh(a,v,c);else if(s.collision=="sphere")l=new Physijs.SphereMesh(a,v,c);else if(s.collision=="cylinder")l=new Physijs.CylinderMesh(a,v,c);else if(s.collision=="cone")l=new Physijs.ConeMesh(a,v,c);else if(s.collision=="capsule")l=new Physijs.CapsuleMesh(a,v,c);else if(s.collision=="convex")l=new Physijs.ConvexMesh(a,v,c);else{if(s.collision!="concave")throw"Unsupported collision mesh type "+s.collision;l=new Physijs.ConcaveMesh(a,v,
c)}r.objects.push(l)}else l=new THREE.Mesh(a,d);s.door&&(n.x=Math.floor(n.x)+.5,n.z=Math.floor(n.z)+.5),n.x*=t.gridSize,n.z*=t.gridSize,!n.y&&n.y!==0&&(n.y=.5*(a.boundingBox.max.y-a.boundingBox.min.y)+.001),l.position.copy(n),i&&(l.rotation.y=i/180*Math.PI),l.scale.set(h,h,h),!s.noShadows&&!s.animation&&(l.castShadow=!0,l.receiveShadow=!0),c===0&&!s.character&&(l.matrixAutoUpdate=!1,l.updateMatrix()),s.animation&&(l.visible=!1,l.geometry=u,l.mesh=animationManager.createAnimatedMesh(a,f,s),s.noShadows||(l.mesh
.castShadow=!0,l.mesh.receiveShadow=!0),l.add(l.mesh)),s.character&&(s.character.hp&&(l.hp=s.character.hp),l.faction=s.character.faction||1,r.monsters.push(l),l.addEventListener("collision",function(e,t,n){if(t.lengthSq()<1)return;e.damage&&s.sound&&soundManager.playSpatial(s.sound,e.position,10);if(this.dead)return;this.hp&&e.damage&&e.position.y>.3&&this.faction!=e.faction&&(this.hp-=e.damage,e.damage=0,this.hp<=0&&(this.dead=!0,this.mesh&&(this.mesh.animate=!1),this.setAngularFactor({x:1,y:1,z:1}),this.setAngularVelocity
({x:0,y:0,z:0}),this.setLinearVelocity({x:0,y:0,z:0}),this.mass=2e3,this.mesh?this.mesh.material=o:this.material=o))})),s.item&&(l.items={},l.items[s.item.type]=s.item.value||1,l.itemName=s.name),e.add(l),s.character&&s.collision&&l.setAngularFactor({x:0,y:1,z:0}),s.character&&(l.speed=s.character.speed);if(s.door){l.setAngularFactor({x:0,y:1,z:0});var m=l.position.clone(),g=.5*(a.boundingBox.max.x-a.boundingBox.min.x)-.1;m.x-=Math.cos(l.rotation.y)*g,m.z+=Math.sin(l.rotation.y)*g;var y=new Physijs.HingeConstraint
(l,m,new THREE.Vector3(0,1,0));e.addConstraint(y),y.setLimits(-Math.PI/2*.95+l.rotation.y,Math.PI/2*.95+l.rotation.y,.3,.01)}}}function l(n){typeof n=="string"&&(n=JSON.parse(n)),n.map instanceof Array&&(n.map=new Map(n.width,n.depth,n.map)),t.geometry.computeBoundingBox(),t.position.x=n.start[0]*n.gridSize,t.position.y=.5*(t.geometry.boundingBox.max.y-t.geometry.boundingBox.min.y)+.001,t.position.z=n.start[1]*n.gridSize,n.startAngle&&controls.setYAngle(n.startAngle),e.add(t),t.setAngularFactor({x:0,y:0,z:0}
),r.generateMesh(n),r.addLights(n),r.addObjects(n),r.addItems(n),r.addMonsters(n),lightManager.update(pl),r.level=n,r.grid=new PF.Grid(n.width,n.depth,n.map.getWalkableMatrix()),r.pathFinder=new PF.AStarFinder({allowDiagonal:!0,dontCrossCorners:!0,heurestic:PF.Heuristic.euclidean}),r.onLoad?r.onLoad():r.onLoad=!0,n.title&&displayMessage(n.title)}var r=this;this.onLoad=null,this.objects=[],this.monsters=[],this.grid=null,this.pathFinder=null,this.level=null;var i=new THREE.MeshBasicMaterial({color:0}),s=new THREE
.MeshBasicMaterial({color:16711935}),o=new THREE.MeshLambertMaterial({color:2236962,ambient:2236962}),u=new THREE.Geometry,a="assets/models/";CONFIG.textureQuality===0?a="assets/models-256/":CONFIG.textureQuality==1&&(a="assets/models-512/"),this.generateMesh=function(t){var n=Math.sqrt(2),r=cache.getMaterial(t.materials.wall),s=assets.materials[t.materials.wall]||{},o=new THREE.Geometry,u=new THREE.Mesh,a,l,c,h,p,d,v,m,g,y,b,w;for(var E=0;E<t.depth;++E)for(var S=0;S<t.width;++S){l=c=h=p=d=v=0,a=t.map.get(S,
E,OPEN);if(a===OPEN)continue;if(a===WALL||a===DIAG){l=t.map.get(S+1,E)==OPEN?1:0,c=t.map.get(S-1,E)==OPEN?2:0,h=t.map.get(S,E+1)==OPEN?4:0,p=t.map.get(S,E-1)==OPEN?8:0,y=l+c+h+p;if(y===0)continue;m=s.roughness?10:0,w=s.repeat||1,b=0,a!==DIAG||y!=5&&y!=6&&y!=9&&y!=10?g=new BlockGeometry(t.gridSize,t.roomHeight,t.gridSize,m,m,m,!1,{px:l,nx:c,py:0,ny:0,pz:h,nz:p},t.gridSize/2*w,t.roomHeight/2*w,s.roughness):(g=new PlaneGeometry(t.gridSize*n,t.roomHeight,m,m,"px",t.gridSize*n/2*w,t.roomHeight/2*w,s.roughness),y==5?
b=-0.25*Math.PI:y==6?b=-0.75*Math.PI:y==9?b=.25*Math.PI:y==10&&(b=.75*Math.PI)),u.geometry=g,u.position.x=(S+.5)*t.gridSize,u.position.y=.5*t.roomHeight,u.position.z=(E+.5)*t.gridSize,u.rotation.y=b,THREE.GeometryUtils.merge(o,u),a===DIAG?g=new THREE.CubeGeometry(.01,t.roomHeight,t.gridSize*n):(g.computeBoundingBox(),Math.abs(g.boundingBox.max.x-g.boundingBox.min.x)<=.5&&(g.boundingBox.min.x=-0.5*t.gridSize,g.boundingBox.max.x=.5*t.gridSize),Math.abs(g.boundingBox.max.z-g.boundingBox.min.z)<=.5&&(g.boundingBox
.min.z=-0.5*t.gridSize,g.boundingBox.max.z=.5*t.gridSize));var x=new Physijs.BoxMesh(g,i,0);x.position.copy(u.position),x.visible=!1,x.matrixAutoUpdate=!1,e.add(x),a===DIAG&&(x.rotation.y=b,x.__dirtyRotation=!0)}}o.dynamic=!1,u=new THREE.Mesh(o,new THREE.MeshFaceMaterial([r])),u.receiveShadow=!0,u.matrixAutoUpdate=!1,u.updateMatrix(),e.add(u),w=assets.materials[t.materials.ceiling]?assets.materials[t.materials.ceiling].repeat||1:1;var T=new Physijs.PlaneMesh(new PlaneGeometry(t.gridSize*t.width,t.gridSize*t.
depth,1,1,"ny",t.width*w,t.depth*w),Physijs.createMaterial(cache.getMaterial(t.materials.ceiling),.9,0),0);T.position.set(t.gridSize*t.width*.5,t.roomHeight,t.gridSize*t.depth*.5),T.matrixAutoUpdate=!1,T.updateMatrix(),T.geometry.dynamic=!1,e.add(T),w=assets.materials[t.materials.floor]?assets.materials[t.materials.floor].repeat||1:1;var N=new Physijs.PlaneMesh(new PlaneGeometry(t.gridSize*t.width,t.gridSize*t.depth,1,1,"py",t.width*w,t.depth*w),Physijs.createMaterial(cache.getMaterial(t.materials.floor),.9,0
),0);N.position.set(t.gridSize*t.width*.5,0,t.gridSize*t.depth*.5),N.receiveShadow=!0,N.matrixAutoUpdate=!1,N.updateMatrix(),N.geometry.dynamic=!1,e.add(N),cache.loadModel("assets/models/teleporter/teleporter.js",f(t,(new THREE.Vector3).set(t.exit[0],null,t.exit[1]),0,assets.objects.teleporter)),CONFIG.particles&&(this.exitParticles=createTeleporterParticles(new THREE.Vector3(t.exit[0]*t.gridSize,.5,t.exit[1]*t.gridSize)))},this.addLights=function(n){function r(t,n){return function(r,i){for(var s=0;s<i.length
;++s)fixAnisotropy(i[s]);r.dynamic=!1;var o=i.length>1?new THREE.MeshFaceMaterial(i):i[0],u=new THREE.Mesh(r,o,0);u.position.copy(t),u.rotation.y=n,u.castShadow=!0,u.receiveShadow=!0,u.matrixAutoUpdate=!1,u.updateMatrix(),e.add(u)}}e.add(new THREE.AmbientLight(4473924));var i=new THREE.Vector2,s=new THREE.Vector3;for(var o=0;o<n.lights.length;++o){n.lights[o].position.y===undefined&&(n.lights[o].position.y=2);var u=new THREE.PointLight(16777130,1,2*n.gridSize);u.position.copy(n.lights[o].position);var f=Math
.random()<.5?"torch-hanging-01":"torch-hanging-02";i.set(n.lights[o].position.x|0,n.lights[o].position.z|0);var l=[{x:i.x+.5,y:i.y,a:Math.PI},{x:i.x+1,y:i.y+.5,a:Math.PI/2},{x:i.x+.5,y:i.y+1,a:0},{x:i.x,y:i.y+.5,a:-Math.PI/2}];i.set(n.lights[o].position.x,n.lights[o].position.z);var c={d:1e3};for(var h=0;h<l.length;++h)l[h].d=i.distanceToSquared(l[h]),l[h].d<c.d&&(c=l[h]);u.position.x=c.x,u.position.z=c.y,i.set((n.lights[o].position.x|0)+.5,(n.lights[o].position.z|0)+.5),i.subSelf(c).multiplyScalar(2),n.map.
get(u.position.x-i.x*.5|0,u.position.z-i.y*.5|0)==WALL?(f="torch",u.position.x+=i.x*.08,u.position.z+=i.y*.08,s.set(u.position.x+i.x,u.position.y-1,u.position.z+i.y)):(u.position.x=(n.lights[o].position.x|0)+.5,u.position.y=n.roomHeight-.9,u.position.z=(n.lights[o].position.z|0)+.5,s.copy(u.position),s.y-=1),u.position.x*=n.gridSize,u.position.z*=n.gridSize,s.x*=n.gridSize,s.z*=n.gridSize;var p=(new THREE.Vector3).copy(u.position);assets.lights[f].offset&&u.position.addSelf(assets.lights[f].offset),u.matrixAutoUpdate=!1
,u.updateMatrix(),e.add(u),lightManager.addLight(u);var d=new THREE.SpotLight(16777130,u.intensity,u.distance);d.position.copy(u.position),d.position.y=n.roomHeight,d.target.position.copy(s),d.angle=Math.PI/2,d.castShadow=!0,d.onlyShadow=!0,d.shadowCameraNear=.1,d.shadowCameraFar=u.distance*1.5,d.shadowCameraFov=100,d.shadowBias=-0.0002,d.shadowDarkness=.3,d.shadowMapWidth=512,d.shadowMapHeight=512,d.shadowCameraVisible=!1,d.matrixAutoUpdate=!1,d.updateMatrix(),e.add(d),lightManager.addShadow(d),cache.loadModel
("assets/models/"+f+"/"+f+".js",r(p,c.a),a+f),CONFIG.particles&&(u.emitter=createTexturedFire(u))}t.light=new THREE.PointLight(13421738,1,n.gridSize*3),e.add(t.light),t.shadow=new THREE.SpotLight(t.light.color.getHex(),t.light.intensity,t.light.distance),t.shadow.angle=Math.PI/4,t.shadow.onlyShadow=!0,t.shadow.castShadow=!0,t.shadow.shadowCameraNear=.1,t.shadow.shadowCameraFar=10,t.shadow.shadowCameraFov=90,t.shadow.shadowBias=-0.0002,t.shadow.shadowDarkness=.3,t.shadow.shadowMapWidth=1024,t.shadow.shadowMapHeight=1024
,t.shadow.shadowCameraVisible=!1,e.add(t.shadow)},this.addObjects=function(e){if(!e.objects)return;for(var t=0;t<e.objects.length;++t){var n=e.objects[t].name;cache.loadModel("assets/models/"+n+"/"+n+".js",f(e,(new THREE.Vector3).copy(e.objects[t].position),e.objects[t].angle,assets.objects[n]),a+n)}},this.addItems=function(e){if(!e.items)return;for(var t=0;t<e.items.length;++t){var n=e.items[t].name;cache.loadModel("assets/models/"+n+"/"+n+".js",f(e,(new THREE.Vector3).copy(e.items[t].position),e.items[t].angle
,assets.items[n]),a+n)}},this.addMonsters=function(e){if(!e.monsters)return;for(var t=0;t<e.monsters.length;++t){var n=e.monsters[t].name;cache.loadModel("assets/models/"+n+"/"+n+".js",f(e,(new THREE.Vector3).copy(e.monsters[t].position),e.monsters[t].angle,assets.monsters[n]),a+n)}},this.getTriggerAt=function(e){if(!this.level||!this.level.triggers)return!1;var t=this.level.triggers;for(var n=0;n<t.length;++n)if(Math.abs(e.x-t[n].position.x*this.level.gridSize)<=1&&Math.abs(e.z-t[n].position.z*this.level.gridSize
)<=1)return t[n]},this.isAtExit=function(e){return this.level&&Math.abs(e.x-this.level.exit[0]*this.level.gridSize)<.5*this.level.gridSize&&Math.abs(e.z-this.level.exit[1]*this.level.gridSize)<.5*this.level.gridSize},n=n||hashParams.level||"cave-test";if(n=="rand"){var c=new MapGen;l(c.generate())}else if(n.length>24){var h=window.atob(n);l(JSON.parse(h))}else $.get("assets/levels/"+n+".json",l);this.serialize=function(){return JSON.stringify(this.level)},this.ready=function(e){this.onLoad===!0?e():this.onLoad=
e}}function initUI(){var e=document.getElementById("container");e.appendChild(renderer.domElement),renderStats=new Stats,renderStats.domElement.style.position="absolute",renderStats.domElement.style.bottom="0px",e.appendChild(renderStats.domElement),physicsStats=new Stats,physicsStats.domElement.style.position="absolute",physicsStats.domElement.style.bottom="0px",physicsStats.domElement.style.left="85px",e.appendChild(physicsStats.domElement),CONFIG.showStats||(renderStats.domElement.style.display="none",physicsStats
.domElement.style.display="none"),rendererInfo=document.getElementById("renderer-info"),e.requestPointerLock=e.requestPointerLock||e.mozRequestPointerLock||e.webkitRequestPointerLock,e.requestFullscreen=e.requestFullscreen||e.mozRequestFullscreen||e.mozRequestFullScreen||e.webkitRequestFullscreen,$(window).resize(onWindowResize),$(window).blur(pause),$(window).focus(resume),$("#instructions").click(function(){if(CONFIG.fullscreen||/Firefox/i.test(navigator.userAgent)){var t=function(n){if(document.fullscreenElement||
document.webkitFullscreenElement||document.mozFullscreenElement||document.mozFullScreenElement)document.removeEventListener("fullscreenchange",t),document.removeEventListener("mozfullscreenchange",t),document.removeEventListener("webkitfullscreenchange",t),e.requestPointerLock()};document.addEventListener("fullscreenchange",t,!1),document.addEventListener("mozfullscreenchange",t,!1),document.addEventListener("webkitfullscreenchange",t,!1),e.requestFullscreen()}else e.requestPointerLock()}),document.addEventListener
("pointerlockchange",onPointerLockChange,!1),document.addEventListener("webkitpointerlockchange",onPointerLockChange,!1),document.addEventListener("mozpointerlockchange",onPointerLockChange,!1),$("#instructions").show(),dat.GUI.TEXT_CLOSED="Close Options",dat.GUI.TEXT_OPEN="Options";var t=new dat.GUI;t.add(CONFIG,"fullscreen").onChange(updateConfig),t.add(CONFIG,"resolution",.1,1).step(.1).onChange(function(){updateConfig(),onWindowResize()}),t.add(CONFIG,"physicsFPS",30,100).step(10).onChange(updateConfig),
t.add(CONFIG,"showStats").onChange(updateConfig),t.add(controls,"mouseFallback"),t.add(window,"editLevel");var n=t.addFolder("Audio");n.add(CONFIG,"sounds").onChange(updateConfig),n.add(CONFIG,"music").onChange(function(){CONFIG.music?soundManager.playMusic("dark-ambiance-01"):soundManager.stopMusic(),updateConfig()});var r=t.addFolder("Renderer options (reload required)");r.add(CONFIG,"antialias").onChange(updateConfig),r.add(CONFIG,"physicalShading").onChange(updateConfig),r.add(CONFIG,"specularMapping").onChange
(updateConfig),r.add(CONFIG,"normalMapping").onChange(updateConfig),r.add(CONFIG,"normalScale",1,5).step(.5).onChange(updateConfig),r.add(CONFIG,"particles").onChange(updateConfig),r.add(window,"reload");var i=t.addFolder("Light and shadow");i.add(CONFIG,"maxLights",0,10).step(1).onChange(updateConfig),i.add(CONFIG,"maxShadows",0,6).step(1).onChange(updateConfig),i.add(CONFIG,"shadows").onChange(updateMaterials),i.add(CONFIG,"softShadows").onChange(updateMaterials);var s=t.addFolder("Texture options");s.add(
CONFIG,"anisotropy",1,renderer.getMaxAnisotropy()).step(1).onChange(updateTextures),s.add(CONFIG,"linearTextureFilter").onChange(updateTextures);var o=t.addFolder("Post-processing");o.add(CONFIG,"postprocessing").onChange(updateConfig),o.add(CONFIG,"SSAO").onChange(updateConfig),o.add(CONFIG,"FXAA").onChange(updateConfig),o.add(CONFIG,"bloom").onChange(updateConfig),t.close()}function updateHUD(){$("#health").html(pl.hp),$("#bullets").html(pl.bullets),$("#clips").html(pl.clips)}function displayMessage(e){var t=
$("#message");messageTimer&&window.clearTimeout(messageTimer),t.is(":visible")&&t.stop(!0,!0).hide(),t.html(e).fadeIn(2e3),messageTimer=window.setTimeout(function(){t.fadeOut(5e3),messageTimer=null},3e3)}function displayMinorMessage(e){var t=$("#minor-messages");t.is(":visible")||t.html(""),t.stop(!0,!0),t.prepend(e+"<br/>").show().fadeOut(5e3)}function editLevel(){var e="editor/index.html#level="+window.btoa(dungeon.serialize());window.open(e,"_blank")}function onWindowResize(){var e=CONFIG.resolution;pl.camera
.aspect=window.innerWidth/window.innerHeight,pl.camera.updateProjectionMatrix(),renderer.setSize(window.innerWidth*e,window.innerHeight*e),colorTarget=new THREE.WebGLRenderTarget(window.innerWidth*e,window.innerHeight*e,renderTargetParametersRGB),composer.reset(colorTarget),depthTarget=new THREE.WebGLRenderTarget(window.innerWidth*e,window.innerHeight*e,renderTargetParametersRGBA),depthPassPlugin.renderTarget=depthTarget,passes.ssao.uniforms.tDepth.value=depthTarget,passes.ssao.uniforms.size.value.set(window
.innerWidth*e,window.innerHeight*e),passes.fxaa.uniforms.resolution.value.set(e/window.innerWidth,e/window.innerHeight),controls.handleResize()}function onPointerLockChange(){document.pointerLockElement||document.mozPointerLockElement||document.webkitPointerLockElement?(controls.pointerLockEnabled=!0,$("#instructions").hide()):(controls.pointerLockEnabled=!1,pl.dead||$("#instructions").show())}function pause(){controls.active=!1}function resume(){controls.active=!0}function reload(){updateConfig(),window.location
.reload()}function init(){scene=new Physijs.Scene({fixedTimeStep:1/CONFIG.physicsFPS}),scene.setGravity(new THREE.Vector3(0,-10,0)),scene.fog=new THREE.FogExp2(0,.05),scene.addEventListener("update",function(){CONFIG.showStats&&physicsStats.update()}),pl=new Physijs.CapsuleMesh(new THREE.CylinderGeometry(.8,.8,2),new THREE.MeshBasicMaterial({color:16711935}),100),pl.visible=!1,pl.geometry.dynamic=!1,pl.addEventListener("collision",function(e,t,n){if(this.dead)return;if(e.items){for(var r in e.items)pl[r]!==undefined&&
(typeof e.items[r]=="number"?pl[r]+=e.items[r]:pl[r]=e.items[r]);soundManager.play("pick-up"),displayMinorMessage("Picked up "+e.itemName),updateHUD(),e.items=undefined,e.visible=!1,e.parent.remove(e)}e.damage&&e.position.y>.3&&pl.faction!=e.faction&&(this.hp-=e.damage,updateHUD())});var e={};hashParams.level&&localStorage.getItem("campaingState-"+hashParams.level)?(e=JSON.parse(localStorage.getItem("campaingState-"+hashParams.level)),pl.hp=e.hp,pl.bulletsPerClip=e.bulletsPerClip,pl.bullets=e.bullets,pl.clips=
e.clips,pl.ammoType=e.ammoType||"plain"):(pl.hp=100,pl.bulletsPerClip=15,pl.bullets=pl.bulletsPerClip,pl.clips=5,pl.ammoType="plain"),pl.reloading=!1,pl.faction=0,updateHUD(),pl.camera=new THREE.PerspectiveCamera(60,window.innerWidth/window.innerHeight,.1,25),controls=new Controls(pl.camera,{mouse:mouseHandler}),controls.movementSpeed=10,controls.lookSpeed=.5,controls.lookVertical=!0,controls.constrainVerticalLook=!0,controls.verticalMin=1.1,controls.verticalMax=2.2,renderer=new THREE.WebGLRenderer({clearColor
:0,antialias:CONFIG.antialias,preserveDrawingBuffer:!0}),renderer.setSize(window.innerWidth,window.innerHeight),renderer.shadowMapDebug=!1,renderer.gammaInput=!0,renderer.gammaOutput=!0,renderer.autoClear=!1,CONFIG.anisotropy||(CONFIG.anisotropy=renderer.getMaxAnisotropy()),renderTargetParametersRGB={minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBFormat},renderTargetParametersRGBA={minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBAFormat},depthTarget=new THREE
.WebGLRenderTarget(window.innerWidth,window.innerHeight,renderTargetParametersRGBA),colorTarget=new THREE.WebGLRenderTarget(window.innerWidth,window.innerHeight,renderTargetParametersRGB),passes.scene=new THREE.RenderPass(scene,pl.camera),passes.ssao=new THREE.ShaderPass(THREE.ShaderExtras.ssao),passes.ssao.uniforms.tDepth.value=depthTarget,passes.ssao.uniforms.size.value.set(window.innerWidth,window.innerHeight),passes.ssao.uniforms.cameraNear.value=pl.camera.near,passes.ssao.uniforms.cameraFar.value=pl.camera
.far,passes.ssao.uniforms.fogNear.value=scene.fog.near,passes.ssao.uniforms.fogFar.value=scene.fog.far,passes.ssao.uniforms.fogEnabled.value=0,passes.ssao.uniforms.aoClamp.value=.4,passes.ssao.uniforms.onlyAO.value=0,passes.fxaa=new THREE.ShaderPass(THREE.ShaderExtras.fxaa),passes.fxaa.uniforms.resolution.value.set(1/window.innerWidth,1/window.innerHeight),passes.bloom=new THREE.BloomPass(.5),passes.adjust=new THREE.ShaderPass(THREE.ShaderExtras.hueSaturation),passes.adjust.uniforms.saturation.value=.2,composer=new 
THREE.EffectComposer(renderer,colorTarget),composer.addPass(passes.ssao),composer.addPass(passes.fxaa),composer.addPass(passes.bloom),composer.addPass(passes.adjust),composer.passes[composer.passes.length-1].renderToScreen=!0,depthPassPlugin=new THREE.DepthPassPlugin,depthPassPlugin.renderTarget=depthTarget,renderer.addPrePlugin(depthPassPlugin),CONFIG.resolution!=1&&onWindowResize(),resetLevel(),updateConfig(),dumpInfo(),initUI()}function resetLevel(e){if(e=="[credits]"){window.location="credits.html";return}
dungeon&&(e&&(window.location.hash="#level="+e),window.location.reload(!0)),lightManager=new LightManager({maxLights:CONFIG.maxLights,maxShadows:CONFIG.maxShadows}),animationManager=new AnimationManager,soundManager=new SoundManager,aiManager=new AIManager,dungeon=new Dungeon(scene,pl,e),CONFIG.music&&soundManager.playMusic("dark-ambiance-01")}function savePlayerState(e){if(!e||e=="[credits]")return;var t={hp:pl.hp,bulletsPerClip:pl.bulletsPerClip,bullets:pl.bullets,clips:pl.clips,ammoType:pl.ammoType};localStorage
.setItem("campaingState-"+e,JSON.stringify(t))}function mouseHandler(e){if(e==2){shootVector.set(0,0,1),projector.unprojectVector(shootVector,pl.camera);var t=new THREE.Ray(pl.camera.position,shootVector.subSelf(pl.camera.position).normalize()),n=t.intersectObjects(dungeon.objects);if(n.length>0){var r=n[0].object;r.position.distanceToSquared(pl.position)<9&&r.applyCentralImpulse(shootVector.multiplyScalar(1e4))}}}function animate(e){function t(e){return Math.abs(e-(e|0)-.5)*2}function n(e){return e-(e|0)}var r
,i=new THREE.Vector3;animationManager.update(e);var s=(new Date).getTime();for(r=0;r<lightManager.lights.length;++r){var o=lightManager.lights[r];o.visible&&o.emitter&&o.emitter.update(e).render()}dungeon.exitParticles&&dungeon.exitParticles.update(e).render(),pl.light.position.set(pl.position.x,pl.position.y+.2,pl.position.z),pl.shadow.position.copy(pl.light.position),pl.shadow.target.position.copy(controls.target)}Detector.webgl||(Detector.addGetWebGLMessage(),document.getElementById("container").innerHTML=""
),Physijs.scripts.worker="libs/physijs_worker.js",Physijs.scripts.ammo="../libs/ammo.js";var hashParams=function(){var e={},t,n=window.location.hash.replace("#","").split("&");for(var r=0;r<n.length;++r)t=n[r].split("="),e[t[0]]=t[1];return e}(),CONFIG={fullscreen:!1,showStats:!1,resolution:1,physicsFPS:60,sounds:!0,music:!0,postprocessing:!0,particles:!0,maxLights:4,maxShadows:2,antialias:!0,anisotropy:0,shadows:!0,softShadows:!0,physicalShading:!0,normalMapping:!0,specularMapping:!0,linearTextureFilter:!0,
bloom:!0,SSAO:!0,FXAA:!1,textureQuality:2,normalScale:2},updateConfig=function(){lightManager.maxLights=CONFIG.maxLights,lightManager.maxShadows=CONFIG.maxShadows,renderer.shadowMapEnabled=CONFIG.shadows,renderer.shadowMapType=CONFIG.softShadows?THREE.PCFShadowMap:THREE.BasicShadowMap,renderer.physicallyBasedShading=CONFIG.physicalShading,passes.bloom.enabled=CONFIG.bloom,passes.ssao.enabled=CONFIG.SSAO,passes.fxaa.enabled=CONFIG.FXAA,scene.setFixedTimeStep(1/CONFIG.physicsFPS);var e=CONFIG.showStats?"block"
:"none";renderStats&&(renderStats.domElement.style.display=e),physicsStats&&(physicsStats.domElement.style.display=e),rendererInfo&&(rendererInfo.style.display=e),localStorage.setItem("CONFIG",JSON.stringify(CONFIG))};(function(){var e=localStorage.getItem("CONFIG");if(e){e=JSON.parse(e);for(var t in e)e.hasOwnProperty(t)&&typeof e[t]!="function"&&(CONFIG[t]=e[t])}})(),"use strict","use strict",PlaneGeometry.prototype=Object.create(THREE.Geometry.prototype),"use strict",BlockGeometry.prototype=Object.create(
THREE.Geometry.prototype),"use strict",AnimationManager.prototype.createAnimatedMesh=function(e,t,n){var r;for(var i=0;i<t.length;++i)n.animation.type==="morph"?(t[i].morphTargets=!0,t[i].morphNormals=!0):n.animation.type==="bones"&&(t[i].skinning=!0);var s=t.length>1?new THREE.MeshFaceMaterial(t):t[0];return n.animation.type==="morph"?(e.computeMorphNormals(),r=new THREE.MorphAnimMesh(e,s),r.duration=n.animation.duration,r.time=r.duration*Math.random()):n.animation.type==="bones"&&(r=new THREE.SkinnedMesh(e
,s),THREE.AnimationHandler.add(e.animation),r.animation=new THREE.Animation(r,"walk")),this.anims.push(r),r},AnimationManager.prototype.update=function(e){for(var t=0;t<this.anims.length;++t){var n=this.anims[t];n.animation&&(!n.animation.isPlaying&&n.animate?n.animation.play():n.animation.isPlaying&&!n.animate&&n.animation.stop());if(n.dead)continue;n.updateAnimation&&n.animate&&n.updateAnimation(e*1e3)}THREE.AnimationHandler.update(e*1e3)},"use strict";var _textures=[],_resizeCanvas=document.createElement("canvas"
);_resizeCanvas.style.display="none",document.body.appendChild(_resizeCanvas);var _resizeCtx=_resizeCanvas.getContext("2d"),performance=window.performance||{};performance.now=function(){return performance.now||performance.mozNow||performance.msNow||performance.oNow||performance.webkitNow||function(){return(new Date).getTime()}}(),"use strict";var _novaTexture=loadTexture("assets/particles/nova.png",{alpha:!0}),_fireTexture=loadTexture("assets/particles/flame.png",{alpha:!0}),_fireGradient=Fireworks.createLinearGradient
().push(0,0).push(.05,1).push(.99,1).push(1,0),particleMaterials={teleporter:new THREE.ParticleBasicMaterial({color:35054,size:.3,sizeAttenuation:!0,vertexColors:!0,map:_novaTexture,blending:THREE.AdditiveBlending,depthWrite:!1,transparent:!0}),simpleFire:new THREE.ParticleBasicMaterial({color:15632384,size:.3,sizeAttenuation:!0,vertexColors:!0,map:Fireworks.ProceduralTextures.buildTexture(),blending:THREE.AdditiveBlending,depthWrite:!1,transparent:!0}),texturedFire:new THREE.SpriteMaterial({map:_fireTexture
,useScreenCoordinates:!1,depthTest:!0,sizeAttenuation:!0,scaleByViewport:!1,blending:THREE.AdditiveBlending,transparent:!0})};"use strict";var assets={objects:{"fern-01":{randScale:.3,noShadows:!0},"fern-02":{randScale:.3,noShadows:!0},"plant-01":{randScale:.3,noShadows:!0},"plant-02":{randScale:.3,noShadows:!0},"plant-03":{randScale:.3,noShadows:!0},"plant-04":{randScale:.3,noShadows:!0},"plant-05":{randScale:.3,noShadows:!0},"rock-01":{collision:"sphere",mass:400,randScale:.4},"rock-02":{collision:"box",mass
:400,randScale:.4},"rock-03":{collision:"box",mass:400,randScale:.4},"rock-04":{collision:"box",mass:500,randScale:.4},barrel:{collision:"cylinder",mass:250},box:{collision:"box",mass:150},"bucket-broken":{collision:"cylinder",mass:50},"netted-jar":{collision:"cylinder",mass:100},"vase-01":{collision:"cylinder",mass:75},"table-big":{collision:"box",mass:1e3},"table-old":{collision:"box",mass:800},"chair-01":{collision:"box",mass:200},"bench-church":{collision:"box",mass:1e3},"torch-standing":{collision:"cylinder"
,mass:150},"mine-cart":{collision:"box",mass:900},"obelisk-01":{collision:"box",mass:0},"obelisk-02":{collision:"box",mass:0},"pillar-broken-01":{collision:"cylinder",mass:0},"pillar-broken-02":{collision:"cylinder",mass:0},"pillar-greek":{collision:"cylinder",mass:0},forge:{collision:"concave",mass:0},"door-barred":{collision:"box",mass:400,door:!0},teleporter:{collision:"cylinder",mass:0}},items:{key:{},knife:{},"health-potion":{},"mana-potion":{}},lights:{"torch-hanging-01":{type:"ceiling",offset:{x:0,y:0
,z:0}},"torch-hanging-02":{type:"ceiling",offset:{x:0,y:0,z:0}},torch:{type:"wall",offset:{x:0,y:0,z:0}}},sounds:{},materials:{"grass-01":{},"grass-02":{},"grass-03":{},"grass-04":{},"metal-01":{repeat:4},"metal-02":{},"metal-03":{},"metal-bumps-01":{repeat:2},"metal-bumps-02":{},"metal-bumps-03":{},"metal-colored-01":{},"metal-colored-02":{repeat:2},"metal-colored-03":{},"metal-colored-04":{},"metal-colored-05":{},"metal-colored-06":{},"metal-colored-07":{},"metal-colored-08":{repeat:2},"metal-colored-09":{
},"metal-corrugated-01":{repeat:2},"metal-corrugated-02":{},"metal-worn-01":{},"metal-worn-02":{},"moss-01":{},"moss-02":{},"rock-01":{roughness:.15},"rock-02":{roughness:.15},"rock-03":{roughness:.15},"rock-04":{roughness:.15},"rock-05":{},"sand-01":{},"sand-02":{},"sand-03":{},"sand-04":{},"stone-01":{},"stone-02":{},"stone-03":{},"stone-floor-01":{},"stone-floor-02":{},"stone-floor-03":{},"stone-floor-04":{},"stone-floor-05":{},"stone-floor-06":{},"tiles-01":{},"tiles-02":{},"wood-floor-01":{}},monsters:{
cerberus:{collision:"box",character:{speed:4,hp:50},animation:{type:"morph",duration:750}},spider:{collision:"box",character:{speed:4,hp:50},animation:{type:"morph",duration:750}},minotaur:{collision:"box",character:{speed:10,hp:50},animation:{type:"morph",duration:750}}},environments:{cave:{wall:["rock-01","rock-02","rock-03","rock-04"],floor:["sand-01","sand-02","sand-03","sand-04"],ceiling:["rock-01","rock-02","rock-03","rock-04"],objects:["rock-01","rock-02","rock-03","rock-04"]},mine:{wall:["rock-01","rock-02"
,"rock-03","rock-04"],floor:["rock-01","rock-02","rock-03","rock-04"],ceiling:["rock-01","rock-02","rock-03","rock-04"],objects:["mine-cart","rock-01","rock-02","rock-03","rock-04","barrel","box","netted-jar","table-old"]},dungeon:{wall:["stone-01","stone-02","stone-03"],floor:["stone-floor-02","stone-floor-05"],ceiling:["stone-01"],objects:["barrel","box","netted-jar","table-old","chair-01"]},castle:{wall:["stone-01","tiles-01","tiles-02"],floor:["stone-floor-01","stone-floor-03","stone-floor-04","stone-floor-06"
,"wood-floor-01"],ceiling:["stone-01"],objects:["barrel","netted-jar","table-big","chair-01"]},temple:{wall:["stone-01","tiles-01","tiles-02"],floor:["stone-floor-01","stone-floor-03","stone-floor-04","stone-floor-06","wood-floor-01"],ceiling:["stone-01"],objects:["pillar-greek","pillar-greek","netted-jar","table-old","chair-01"]}}};"use strict";var VOID=" ",OPEN=".",WALL="#",DIAG="%";"use strict","use strict","use strict";var renderStats,physicsStats,rendererInfo,messageTimer=null;"use strict";var pl,controls
,scene,renderer,composer,renderTargetParametersRGBA,renderTargetParametersRGB,colorTarget,depthTarget,depthPassPlugin,lightManager,animationManager,soundManager,aiManager,dungeon,projector=new THREE.Projector,clock=new THREE.Clock,cache=new Cache,passes={},shootVector=new THREE.Vector3;$(document).ready(function(){function n(e){var t=["Prog:",e.memory.programs,"Geom:",e.memory.geometries,"Tex:",e.memory.textures,"Calls:",e.render.calls,"Verts:",e.render.vertices,"Faces:",e.render.faces,"Pts:",e.render.points
];return t.join(" ")}function r(){requestAnimationFrame(r);if(pl.dead)return;var i=clock.getDelta();i>.05&&(i=.05),e.set(pl.camera.position.x,0,pl.camera.position.z),controls.update(i),t.set(pl.camera.position.x,0,pl.camera.position.z),t.subSelf(e),t.divideScalar(i);var s=pl.getLinearVelocity().y;pl.setLinearVelocity({x:t.x,y:s<0?s:0,z:t.z}),scene.simulate(),controls.object.position.set(pl.position.x,pl.position.y+.5,pl.position.z),pl.rotation.copy(pl.camera.rotation),pl.__dirtyRotation=!0,animate(i),renderer
.clear(),CONFIG.postprocessing?(renderer.shadowMapEnabled=CONFIG.shadows,depthPassPlugin.enabled=!0,renderer.render(scene,pl.camera,composer.renderTarget2,!0),CONFIG.showStats&&(rendererInfo.innerHTML=n(renderer.info)),renderer.shadowMapEnabled=!1,depthPassPlugin.enabled=!1,composer.render(i)):(renderer.render(scene,pl.camera),CONFIG.showStats&&(rendererInfo.innerHTML=n(renderer.info))),CONFIG.showStats&&renderStats.update()}var e=new THREE.Vector3,t=new THREE.Vector3;init(),dungeon.ready(function(){window.setInterval
(function(){lightManager.update(pl)},690),window.setInterval(function(){pl.dead||aiManager.process()},100),window.setInterval(function(){!pl.dead&&pl.hp<=0&&(pl.dead=!0,controls.active=!1,$("#deathscreen").is(":visible")||$("#deathscreen").fadeIn(500),$("#instructions").hide());var e=dungeon.getTriggerAt(pl.position);e&&e.type=="message"&&displayMessage(e.message),dungeon.isAtExit(pl.position)&&(savePlayerState(dungeon.level.next),resetLevel(dungeon.level.next))},45),r()})});